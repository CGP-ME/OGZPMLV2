---
title: OGZPrime V14 â€” Complete System Architecture
---

%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%% OGZPrime Full Architecture Map
%% For AI assistants: This is the SINGLE SOURCE OF TRUTH for how
%% data flows through the system. Read this before touching anything.
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% EXTERNAL DATA SOURCES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph EXTERNAL["ğŸŒ External Data Sources"]
        KWS["Kraken WebSocket<br/>wss://ws.kraken.com<br/>Ticker + OHLC (7 timeframes)"]
        KREST["Kraken REST API<br/>api.kraken.com<br/>Historical candles, Orders, Balance"]
        DASH["Dashboard UI<br/>unified-dashboard.html<br/>via ogzprime-ssl-server.js WSS"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% BROKER LAYER (BrokerFactory Chain)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph BROKER["ğŸ­ Broker Layer (BrokerFactory Chain)"]
        direction TB
        BF["BrokerFactory.js<br/>createBrokerAdapter('kraken', opts)"]
        KIB["KrakenIBrokerAdapter.js<br/>IBroker interface wrapper<br/><i>bot.kraken = this</i>"]
        KAS["kraken_adapter_simple.js<br/>Raw Kraken connection<br/><i>bot.kraken.kraken = this</i><br/><br/>Key Props:<br/>â€¢ this.ws (raw WebSocket)<br/>â€¢ this.tradingPair ('XBT/USD')<br/>â€¢ this.currentPrices (Map)<br/>â€¢ this.connected (bool)"]

        BF --> KIB
        KIB --> KAS
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTION FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    KWS -- "ticker + ohlc-{1,5,15,30,60,240,1440}" --> KAS
    KREST -- "getHistoricalOHLC(pair, interval, count)<br/>placeOrder(order)<br/>getBalance()" --> KAS
    KAS -- "emit('ohlc', {data, timeframe})<br/>emit('ticker', {price})" --> KIB

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% BOT CORE (run-empire-v2.js)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph BOT["ğŸ¤– run-empire-v2.js â€” The Bot"]
        direction TB

        subgraph INIT["Constructor + Startup"]
            CTOR["constructor()<br/>Initializes all modules"]
            START["start()<br/>â†’ connect broker<br/>â†’ subscribeToMarketData()<br/>â†’ loadCandleHistory()<br/>â†’ startTradingCycle()<br/>â†’ startLivenessWatchdog()<br/>â†’ initializeDashboardWebSocket()"]
        end

        subgraph DATA_IN["ğŸ“¡ Data Ingestion"]
            HMD["handleMarketData(ohlcData)<br/>â€¢ Builds candle {o,h,l,c,v,t,etime}<br/>â€¢ Pushes to this.priceHistory[200max]<br/>â€¢ Computes indicators via IndicatorEngine<br/>â€¢ Broadcasts to dashboard<br/>â€¢ Calls saveCandleHistory() every 5 candles"]
            STC["storeTimeframeCandle(tf, ohlc)<br/>â€¢ Stores in this.timeframeHistories[tf]<br/>â€¢ Max 200 per timeframe"]
            FHSC["fetchAndSendHistoricalCandles(tf, limit)<br/>â€¢ Calls bot.kraken.getCandles(symbol, tf)<br/>â€¢ Sends to dashboard via WS"]
        end

        subgraph TRADING_CYCLE["ğŸ”„ Trading Cycle (every 15s)"]
            AAT["analyzeAndTrade()<br/>THE MAIN LOOP"]
            AAT_STEPS["1. IndicatorEngine.getSnapshot()<br/>2. patternChecker.analyzePatterns()<br/>3. ogzTpo.update() â€” TwoPole oscillator<br/>4. regimeDetector.detectRegime()<br/>5. tradingBrain.getDecision()<br/>6. trai.processDecision() â€” AI overlay<br/>7. makeTradeDecision() â€” final verdict<br/>8. executeTrade() if signal fires"]
        end

        subgraph DECISION["ğŸ§  Decision Pipeline"]
            MTD["makeTradeDecision(confidence, indicators, patterns, price)<br/>â€¢ Checks stateManager.get('position')<br/>â€¢ If in position â†’ checks MaxProfitManager exit<br/>â€¢ If not â†’ evaluates BUY/SELL signal<br/>â€¢ Returns {action, confidence, reasons[]}"]
        end

        subgraph EXECUTION["âš¡ Trade Execution"]
            ET["executeTrade(decision, confidence, price, indicators, patterns)<br/>â€¢ rateLimiter.allow() gate<br/>â€¢ riskManager.calculatePositionSize()<br/>â€¢ tradingOptimizations.calculatePositionSize() â€” pattern sizing<br/>â€¢ executionLayer.executeTrade() â†’ Kraken order<br/>â€¢ stateManager.openPosition() / closePosition()<br/>â€¢ maxProfitManager.start() on entry<br/>â€¢ Broadcasts trade_executed / trade_closed to dashboard"]
        end

        subgraph DASHBOARD_WS["ğŸ“Š Dashboard WebSocket Handler"]
            DWS_MSGS["Inbound Messages:<br/>â€¢ auth_success â†’ identify bot<br/>â€¢ pong â†’ heartbeat tracking<br/>â€¢ timeframe_change â†’ fetchAndSendHistoricalCandles<br/>â€¢ request_historical â†’ fetchAndSendHistoricalCandles<br/>â€¢ asset_change â†’ assetManager.switchAsset()<br/>â€¢ command:switch_profile â†’ profileManager<br/>â€¢ command:set_confidence â†’ brain threshold<br/>â€¢ command:pause_trading â†’ stateManager.pauseTrading<br/>â€¢ command:resume_trading â†’ stateManager.resumeTrading<br/>â€¢ trai_query â†’ handleTraiQuery()"]
        end
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CORE MODULES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph MODULES["ğŸ“¦ Core Modules"]
        direction TB

        subgraph ANALYSIS["Analysis Layer"]
            IE["IndicatorEngine<br/>updateCandle(c) â†’ getSnapshot()<br/>Returns: {rsi, macd, ema20/50/200,<br/>bollinger, atr, adx, obv, vwap,<br/>momentum, trendStrength}"]
            PC["EnhancedPatternRecognition<br/>analyzePatterns({candles, indicators})<br/>Returns: [{name, confidence, direction}]<br/>Uses: PatternMemoryBank, PersistentPatternMap"]
            RD["MarketRegimeDetector<br/>detectRegime(candles)<br/>Returns: 'trending_up'|'trending_down'|<br/>'ranging'|'volatile'|'breakout'"]
            TPO["OgzTpoIntegration<br/>update({candles, price, volume})<br/>Returns: {signal, score, tpo_value}<br/>Uses: TwoPoleOscillator, ogzTwoPoleOscillator"]
            FIB["FibonacciDetector<br/>detect(candles, price)<br/>Returns: {levels[], nearestSupport, nearestResistance}"]
            SR["SupportResistanceDetector<br/>detect(candles)<br/>Returns: {supports[], resistances[]}"]
        end

        subgraph BRAIN["Decision Layer"]
            TB_MOD["OptimizedTradingBrain (3422 lines)<br/>getDecision(price, candles, indicators, regime)<br/>Returns: {action, confidence, direction, reasons[]}<br/><br/>Internal modules:<br/>â€¢ MaxProfitManager â€” trailing exits<br/>â€¢ FibonacciDetector â€” levels<br/>â€¢ SupportResistanceDetector â€” S/R<br/>â€¢ MemoryManager â€” state persistence<br/>â€¢ ErrorHandler â€” circuit breaker<br/>â€¢ PersistentPatternMap â€” pattern history"]
            TRAI["TRAIDecisionModule<br/>processDecision(signal, context)<br/>Returns: {action, confidence, veto, reasoning}<br/>Uses: trai_core â†’ PatternMemoryBank,<br/>persistent_llm_client"]
            TIE["TradeIntelligenceEngine<br/>evaluate(trade, marketData, indicators)<br/>Returns: {holdScore, exitScore, analysis}"]
        end

        subgraph RISK["Risk & Execution Layer"]
            RM["RiskManager (1938 lines)<br/>calculatePositionSize(balance, price, conditions)<br/>recordTradeResult(trade)<br/>Tracks: daily/weekly/monthly P&L,<br/>drawdown, consecutive losses, win rate"]
            EL["AdvancedExecutionLayer<br/>executeTrade(params) â†’ Kraken order<br/>setKrakenAdapter(adapter)<br/>setWebSocketClient(ws)<br/>Tracks: holdings, P&L, duplicate detection"]
            RL["ExecutionRateLimiter<br/>allow({symbol, action, currentPosition})<br/>Returns: {allowed, reason}"]
            SM["StateManager (SINGLETON)<br/>THE source of truth for:<br/>â€¢ position (number)<br/>â€¢ balance (number)<br/>â€¢ activeTrades (Map)<br/>â€¢ isPaused (bool)<br/>â€¢ dailyPnL, weeklyPnL<br/><br/>Methods:<br/>â€¢ openPosition(size, price)<br/>â€¢ closePosition(price)<br/>â€¢ pauseTrading(reason)<br/>â€¢ resumeTrading()<br/>â€¢ setDashboardWs(ws) â€” auto-broadcasts state"]
        end

        subgraph UTILITY["Utility Modules"]
            PM["TradingProfileManager<br/>getActiveProfile() â†’ {name, settings}<br/>Profiles: Conservative, Balanced,<br/>Aggressive, Scalper"]
            FF["FeatureFlagManager<br/>isEnabled(flag) â†’ bool<br/>getSetting(flag, key, default)"]
            TO["TradingOptimizations<br/>calculatePositionSize(size, patternIds, context)<br/>Pattern-weighted position adjustment"]
            TEL["Telemetry<br/>track(event, data) â€” metrics"]
            MQ["MessageQueue<br/>Internal pub/sub messaging"]
            SL["SingletonLock<br/>Prevents multiple bot instances"]
            MAL["ModuleAutoLoader<br/>loader.get('core', 'ModuleName')<br/>Auto-resolves paths, caches modules"]
            TL["tradeLogger<br/>logTrade(data) â€” file-based trade log"]
        end
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% DATA FLOW CONNECTIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    %% Broker to Bot
    KIB -- "emit('ohlc', {data, timeframe})" --> HMD
    KIB -- "emit('ohlc', {data, tf}) where tf!='1m'" --> STC

    %% Data Ingestion to Trading
    HMD --> AAT
    AAT --> AAT_STEPS

    %% Analysis chain
    AAT_STEPS --> IE
    AAT_STEPS --> PC
    AAT_STEPS --> RD
    AAT_STEPS --> TPO

    %% Brain decision
    IE --> TB_MOD
    PC --> TB_MOD
    RD --> TB_MOD
    TPO --> TB_MOD
    TB_MOD --> TRAI
    TRAI --> MTD

    %% Execution
    MTD --> ET
    ET --> RL
    ET --> RM
    ET --> TO
    ET --> EL
    EL --> KIB
    ET --> SM

    %% Dashboard
    DASH <-- "WSS bidirectional" --> DWS_MSGS
    HMD -- "market_update broadcast" --> DASH
    ET -- "trade_executed / trade_closed" --> DASH
    SM -- "state_update auto-broadcast" --> DASH
    DWS_MSGS --> FHSC

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    classDef external fill:#1a1a2e,stroke:#e94560,color:#fff
    classDef broker fill:#16213e,stroke:#0f3460,color:#fff
    classDef bot fill:#0f3460,stroke:#533483,color:#fff
    classDef analysis fill:#1a1a2e,stroke:#e94560,color:#fff
    classDef brain fill:#533483,stroke:#e94560,color:#fff
    classDef risk fill:#0f3460,stroke:#e94560,color:#fff
    classDef state fill:#e94560,stroke:#fff,color:#fff

    class KWS,KREST,DASH external
    class BF,KIB,KAS broker
    class HMD,STC,FHSC,AAT,AAT_STEPS,MTD,ET,DWS_MSGS bot
    class IE,PC,RD,TPO,FIB,SR analysis
    class TB_MOD,TRAI,TIE brain
    class RM,EL,RL risk
    class SM state
