<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OGZPrime Unified Trading System - Live Dashboard</title>
    <!-- TradingView Lightweight Charts v4.1 -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-panel: rgba(20, 20, 20, 0.9);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            
            /* Version-specific colors */
            --core-color: #00ccff;
            --ml-color: #ffd700;
            
            --profit-color: #00ff88;
            --loss-color: #ff3366;
            --neutral-color: #8b8b8b;
            
            --metallic-gradient: linear-gradient(135deg, #c0c0c0 0%, #808080 50%, #c0c0c0 100%);
            --core-gradient: linear-gradient(135deg, #00ccff 0%, #4dddff 50%, #00ccff 100%);
            --ml-gradient: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            overflow-y: auto;  /* CHANGE 2026-01-31: Allow page scroll for full content */
            min-height: 100vh;
            cursor: default;  /* CHANGE 2026-01-23: Fix crosshair bleeding to whole page */
            position: relative;
        }
        
        /* Background effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Header */
        .header {
            background: linear-gradient(180deg, #0d0d1a 0%, #080812 100%);
            padding: 12px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 10;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 900;
            background: var(--metallic-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 5px;
            text-shadow: 0 0 30px rgba(192, 192, 192, 0.5);
        }
        
        .tagline {
            color: #666666;
            font-size: 14px;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        /* Tier Selector - Prominent placement */
        .tier-selector-container {
            position: absolute;
            top: 20px;
            right: 80px; /* Moved left to avoid theme-customizer at right:20px */
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 15;
        }
        
        .tier-label {
            color: var(--ml-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .tier-selector {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--ml-color);
            color: var(--ml-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            min-width: 250px;
        }
        
        .tier-selector:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .tier-selector option {
            background: #000;
            color: #fff;
            padding: 5px;
        }
        
        /* Dynamic border color based on selected version */
        .tier-core .tier-selector { border-color: var(--core-color); color: var(--core-color); }
        .tier-ml .tier-selector { border-color: var(--ml-color); color: var(--ml-color); }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff0040;
            animation: statusPulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--profit-color);
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* CHANGE 2026-01-22: Multi-status lights bar */
        .status-lights-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-left: 15px;
        }

        .status-light {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-light .light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .status-light .light.green {
            background: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
        }

        .status-light .light.yellow {
            background: #ffcc00;
            box-shadow: 0 0 8px rgba(255, 204, 0, 0.6);
            animation: statusPulse 1.5s infinite;
        }

        .status-light .light.red {
            background: #ff3366;
            box-shadow: 0 0 8px rgba(255, 51, 102, 0.6);
        }

        .status-light .label {
            color: #888;
        }

        .status-light .light.green + .label {
            color: #00ff88;
        }

        .status-light .light.yellow + .label {
            color: #ffcc00;
        }

        .status-light .light.red + .label {
            color: #ff3366;
        }
        
        /* Main Container */
        .main-container {
            padding: 10px;
            padding-left: 340px;  /* Space for left panel (320px + 20px gap) */
            padding-right: 340px; /* Space for right panel (320px + 20px gap) */
            position: relative;
            z-index: 5;
            transition: padding 0.3s ease;
        }

        /* Dynamic padding when panels collapse */
        .main-container.left-collapsed {
            padding-left: 60px;
        }

        .main-container.right-collapsed {
            padding-right: 60px;
        }
        
        /* Unified Chart Section */
        .unified-chart-section {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        /* Dynamic version border highlighting */
        .tier-core .unified-chart-section { border-color: var(--core-color); }
        .tier-ml .unified-chart-section { border-color: var(--ml-color); }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chart-title-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .chart-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
        }
        
        .price-display {
            font-size: 20px;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--profit-color);
            color: var(--profit-color);
            font-family: 'Orbitron', monospace;
        }
        
        /* Dynamic version coloring */
        .tier-core .chart-title {
            background: var(--core-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 204, 255, 0.8);
        }

        .tier-ml .chart-title {
            background: var(--ml-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .indicator-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: rgba(26, 0, 0, 0.8);
            border: 1px solid #ff0040;
            border-radius: 5px;
            padding: 8px;
            max-width: 600px;
        }

        .indicator-check {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none;
            font-size: 13px;  /* Increased from 11px */
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            padding: 3px 6px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .indicator-check:hover {
            background: rgba(255, 0, 64, 0.1);
        }

        .indicator-check input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .color-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        select, button {
            background: rgba(26, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #ff0040;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        
        select:hover, button:hover {
            background: #ff0040;
            box-shadow: 0 0 15px rgba(255, 0, 64, 0.6);
            transform: translateY(-2px);
        }
        
        /* Chart Container - TradingView */
        .chart-container {
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 6px;
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            height: calc(100vh - 200px);  /* CHANGE 2026-01-28: Fill viewport minus header */
            min-height: 500px;
            width: 100%;
        }
        
        #tvChartContainer {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            cursor: crosshair;  /* CHANGE 2026-01-23: Crosshair only on chart */
        }
        
        /* Multiple Bot Status Display */
        .bot-status-row {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            z-index: 15;
        }
        
        .bot-status-indicator {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;  /* Increased for readability */
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid;
            transition: all 0.3s ease;
        }
        
        .bot-status-indicator.core {
            background: rgba(0, 204, 255, 0.1);
            border-color: var(--core-color);
            color: var(--core-color);
        }

        .bot-status-indicator.ml {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--ml-color);
            color: var(--ml-color);
        }
        
        .bot-status-indicator.active {
            animation: botPulse 1s infinite;
        }
        
        @keyframes botPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Indicator Overlays */
        .indicator-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
            z-index: 10;
            min-width: 200px;
            max-width: 280px;
            max-height: 55vh; /* Reduced to account for new top position */
            overflow-y: auto;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* Custom scrollbar */
        .indicator-overlay::-webkit-scrollbar {
            width: 6px;
        }

        .indicator-overlay::-webkit-scrollbar-track {
            background: rgba(20, 20, 40, 0.3);
            border-radius: 3px;
        }

        .indicator-overlay::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 3px;
        }

        .indicator-overlay::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.6);
        }
        
        .indicator-overlay h4 {
            color: #ffd700;
            font-size: 12px;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 13px;  /* Increased for readability */
        }
        
        .indicator-label {
            color: #ccc;
        }
        
        .indicator-value {
            color: #ffd700;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
        }
        
        /* Indicator panel visibility */
        .indicators-panel {
            display: none;
        }

        .tier-core .core-indicators {
            display: block;
        }

        .tier-ml .ml-indicators {
            display: block;
        }
        
        /* Trading Panel */
        .trading-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .panel-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(14, 14, 14, 0.95) 100%);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            padding: 14px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
        }
        
        .panel-title {
            color: #ffd700;
            font-size: 16px;  /* Increased for better visibility */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 8px;
        }
        
        /* Trade Controls */
        .trade-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .trade-btn {
            flex: 1;
            padding: 12px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .trade-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .trade-btn:hover:before {
            left: 100%;
        }
        
        .buy-btn {
            background: linear-gradient(135deg, #00ff41, #00cc33);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }
        
        .sell-btn {
            background: linear-gradient(135deg, #ff4444, #cc1111);
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        .kill-btn {
            background: linear-gradient(135deg, #ff6600, #cc4400);
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
        }
        
        .long-btn {
            background: linear-gradient(135deg, #1e90ff, #0066cc);
            color: #fff;
            box-shadow: 0 0 20px rgba(30, 144, 255, 0.3);
        }
        
        .short-btn {
            background: linear-gradient(135deg, #9400d3, #6a0dad);
            color: #fff;
            box-shadow: 0 0 20px rgba(148, 0, 211, 0.3);
        }
        
        .hedge-btn {
            background: linear-gradient(135deg, #ff8c00, #cc7000);
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.3);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            border-color: rgba(255, 215, 0, 0.4);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        
        .stat-label {
            font-size: 13px;  /* Increased from 11px */
            color: #aaa;  /* Brightened from #888 */
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #ffd700;
            font-family: 'Orbitron', monospace;
        }
        
        .positive { color: var(--profit-color) !important; }
        .negative { color: var(--loss-color) !important; }
        
        /* Trade Log - CHANGE 2026-01-31: Increased height to prevent cutoff */
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 5px;
        }

        .trade-log-entry {
            display: grid;
            grid-template-columns: 60px 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid transparent;
        }

        .trade-log-entry:has(.trade-type[style*="00ff41"]) {
            border-left-color: #00ff41;
        }

        .trade-log-entry:has(.trade-type[style*="ff4444"]) {
            border-left-color: #ff4444;
        }

        .trade-type {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .trade-value {
            font-weight: 600;
            text-align: center;
        }

        .trade-time {
            color: #888;
            font-size: 11px;
            text-align: right;
        }

        .trade-duration {
            color: #666;
            font-size: 11px;
            margin-left: 5px;
        }

        /* Chain of Thought - CHANGE 2026-01-30: Enhanced styling */
        .chain-of-thought {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .thought-entry {
            padding: 15px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 20, 40, 0.8) 100%);
            border-radius: 12px;
            border-left: 4px solid #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.1);
        }

        .thought-step {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .thought-step strong {
            color: #ffd700;
        }

        .decision-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .decision-badge.buy {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .decision-badge.sell {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
        }

        .decision-badge.hold {
            background: linear-gradient(135deg, #ffd700 0%, #cc9900 100%);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        }

        .thought-step {
            font-size: 13px;  /* Increased for readability */
            margin-bottom: 5px;
            color: #ccc;
        }

        .thought-step strong {
            color: #ffd700;
        }

        /* Pattern Panel */
        .pattern-panel {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1) 0%, rgba(75, 0, 130, 0.1) 100%);
            border: 1px solid rgba(138, 43, 226, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .pattern-display {
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
        }

        .pattern-name {
            font-weight: 700;
            color: #8a2be2;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 10px;
        }

        /* CHANGE 2026-01-30: Enhanced for SVG pattern display */
        .pattern-visual {
            text-align: center;
            margin-bottom: 10px;
            min-height: 80px;
            background: rgba(0, 20, 40, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .pattern-visual svg {
            max-width: 100%;
            height: auto;
        }

        .pattern-description {
            font-size: 13px;  /* Increased for readability */
            color: #aaa;
        }

        .pattern-info {
            margin: 0;
            line-height: 1.4;
        }

        /* Neural Ensemble - HIDDEN: Commented out for proof display */
        .neural-ensemble {
            display: none; /* CHANGE 2026-01-29: Hidden for proof-only display */
            margin-top: 20px;
        }
        
        .ensemble-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .brain-module {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 20, 0.9));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .brain-module:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .brain-name {
            font-size: 12px;  /* Increased for readability */
            color: #666666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .brain-vote {
            font-weight: 700;
            font-size: 14px;
            font-family: 'Orbitron', monospace;
        }
        
        .brain-confidence {
            font-size: 12px;  /* Increased for readability */
            color: #888;
            margin-top: 3px;
        }
        
        .vote-long { color: #00ff41; }
        .vote-short { color: #ff4444; }
        .vote-hedge { color: #ff8c00; }
        .vote-hold { color: #8b8b8b; }

        /* Upgrade Prompt */
        .upgrade-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.9));
            color: #000;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            z-index: 100;
            display: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a0000;
        }

        ::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffed4e;
        }
        /* Responsive Design for Different Devices */
        @media screen and (max-width: 1920px) {
            /* Desktop */
            .container {
                max-width: 95%;
            }
        }

        @media screen and (max-width: 1440px) {
            /* Laptop */
            .indicator-overlay {
                max-width: 250px;
                font-size: 11px;
            }

            .chart-container {
                height: calc(100vh - 180px);  /* CHANGE 2026-01-28: Viewport-relative */
                min-height: 450px;
            }
        }

        @media screen and (max-width: 1024px) {
            /* Tablet Landscape */
            .indicator-overlay {
                max-width: 220px;
                font-size: 10px;
                max-height: 50vh;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .chart-container {
                height: calc(100vh - 180px);  /* CHANGE 2026-01-28: Viewport-relative */
                min-height: 400px;
            }
        }

        @media screen and (max-width: 768px) {
            /* Tablet Portrait */
            .indicator-overlay {
                position: fixed;
                top: 10px;
                left: 10px;
                max-width: 180px;
                font-size: 9px;
                padding: 8px;
                max-height: 40vh;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                height: 450px;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media screen and (max-width: 480px) {
            /* Mobile */
            .indicator-overlay {
                position: fixed;
                bottom: 10px;
                left: 10px;
                right: 10px;
                top: auto;
                max-width: none;
                max-height: 150px;
                font-size: 9px;
                padding: 6px;
            }

            .indicator-item {
                margin: 2px 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .chart-container {
                height: 300px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .panel-title {
                font-size: 12px;
            }
        }

        @media screen and (max-width: 320px) {
            /* Small Mobile */
            .indicator-overlay {
                font-size: 8px;
                max-height: 120px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }
        }

        /* ========================================
           RESPONSIVE RULES FOR FIXED PANELS
           Auto-adapts to device size
           ======================================== */

        /* Tablet Landscape (1024px) - Reduce panel widths */
        @media screen and (max-width: 1024px) {
            .edge-panel {
                width: 280px;
                right: 10px;
            }

            .trade-manager {
                right: 10px;
            }

            .theme-customizer {
                right: 10px;
            }

            .tier-selector-container {
                right: 70px;
            }

            .drawing-tools {
                left: 10px;
            }
        }

        /* Tablet Portrait (768px) - Collapse panels by default */
        @media screen and (max-width: 768px) {
            .edge-panel {
                width: 260px;
                right: 10px;
                top: 120px;
                max-height: 60vh;
            }

            .edge-panel.collapsed {
                width: 45px;
                height: 45px;
            }

            .trade-manager {
                top: 70px;
                right: 10px;
            }

            .trade-panel {
                width: 300px;
                max-height: 70vh;
            }

            .theme-customizer {
                top: 10px;
                right: 10px;
            }

            .theme-panel {
                width: 280px;
            }

            .tier-selector-container {
                position: relative;
                top: auto;
                right: auto;
                justify-content: center;
                margin-top: 10px;
            }

            .tier-selector {
                min-width: 200px;
            }

            .drawing-tools {
                top: 70px;
                left: 10px;
            }

            .bot-status-row {
                top: 10px;
                left: 10px;
                flex-wrap: wrap;
                gap: 5px;
            }

            .indicator-overlay {
                top: 45px;
                left: 10px;
                max-width: 200px;
                max-height: 45vh;
            }
        }

        /* Mobile (480px) - Stack vertically, bottom sheet approach */
        @media screen and (max-width: 480px) {
            .edge-panel {
                position: fixed;
                bottom: 10px;
                top: auto;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 40vh;
                border-radius: 15px 15px 0 0;
            }

            .edge-panel.collapsed {
                bottom: 10px;
                left: auto;
                right: 10px;
                width: 45px;
                height: 45px;
            }

            .trade-manager {
                top: 10px;
                right: 60px; /* Space for theme-customizer */
            }

            .trade-panel {
                position: fixed;
                top: auto;
                bottom: 60px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 50vh;
            }

            .theme-customizer {
                top: 10px;
                right: 10px;
            }

            .theme-toggle {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .theme-panel {
                position: fixed;
                top: auto;
                bottom: 10px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 60vh;
            }

            .drawing-tools {
                top: auto;
                bottom: 60px;
                left: 10px;
            }

            .drawing-tools.collapsed {
                bottom: 10px;
            }

            .tool-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .bot-status-row {
                top: 5px;
                left: 5px;
                gap: 3px;
            }

            .bot-status-indicator {
                padding: 3px 6px;
                font-size: 10px;
            }

            .tier-selector-container {
                display: none; /* Hide on mobile - use menu instead */
            }
        }

        /* Landscape Mobile - Side by side panels */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .edge-panel {
                position: fixed;
                right: 10px;
                top: 60px;
                bottom: auto;
                width: 250px;
                max-height: 70vh;
            }

            .indicator-overlay {
                left: 10px;
                top: 60px;
                max-width: 180px;
                max-height: 60vh;
            }

            .chart-container {
                height: 280px;
            }
        }

        /* Edge Analytics Panel - THE REAL MONEY MAKERS */
        .edge-panel {
            position: fixed;
            right: 10px;
            top: 100px;
            width: 320px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            background: rgba(10, 10, 30, 0.95);
            border: 2px solid rgba(255, 0, 100, 0.5);
            border-radius: 15px;
            padding: 15px;
            z-index: 98;
            box-shadow: 0 0 30px rgba(255, 0, 100, 0.3);
            transition: all 0.3s ease;
        }

        .edge-panel.collapsed {
            width: 50px;
            height: 50px;
            max-height: 50px;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
        }

        .edge-panel.collapsed .edge-content {
            display: none;
        }

        .edge-panel.collapsed .edge-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            margin: 0;
            padding: 15px 5px;
            font-size: 12px;
        }

        .edge-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 100, 0.3);
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
        }

        .edge-toggle:hover {
            background: rgba(255, 0, 100, 0.6);
        }

        .edge-header {
            color: #ff0064;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 0, 100, 0.8);
            animation: pulse-glow 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(255, 0, 100, 0.8); }
            50% { text-shadow: 0 0 20px rgba(255, 0, 100, 1); }
        }

        .edge-section {
            background: rgba(20, 20, 40, 0.6);
            border: 1px solid rgba(255, 0, 100, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .edge-section h4 {
            color: #fff;
            font-size: 13px;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 0, 100, 0.3);
        }

        /* Liquidation Levels */
        .liq-levels {
            margin-bottom: 10px;
        }

        /* CHANGE 2026-01-30: Increased font size for readability */
        .liq-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 13px;
        }

        .long-liq {
            background: rgba(255, 0, 0, 0.1);
            border-left: 3px solid #ff0000;
        }

        .short-liq {
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid #00ff00;
        }

        .liq-price {
            font-weight: bold;
            color: #ffd700;
        }

        .liq-volume {
            color: #00d4ff;
        }

        /* CVD Display */
        .cvd-display {
            text-align: center;
        }

        .cvd-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
        }

        .cvd-trend {
            padding: 4px 8px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 5px;
            margin-top: 5px;
            display: inline-block;
            font-size: 11px;
        }

        /* Funding Rates */
        .funding-display {
            font-size: 12px;
        }

        .funding-current, .funding-predicted {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .funding-rate {
            font-weight: bold;
        }

        .funding-signal {
            text-align: center;
            padding: 5px;
            margin-top: 10px;
            background: rgba(100, 100, 200, 0.2);
            border-radius: 5px;
            font-weight: bold;
        }

        /* Whale Alerts */
        .whale-alerts {
            max-height: 100px;
            overflow-y: auto;
        }

        /* CHANGE 2026-01-30: Increased font size for readability */
        .whale-item {
            padding: 8px;
            margin: 4px 0;
            background: rgba(0, 100, 255, 0.1);
            border-left: 3px solid #0064ff;
            border-radius: 3px;
            font-size: 12px;
            animation: slideInLeft 0.5s;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Market Internals - CHANGE 2026-01-30: Increased font size */
        .internal-item, .metric-item, .smart-item {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }

        .internal-item span:last-child,
        .metric-item span:last-child,
        .smart-item span:last-child {
            font-weight: bold;
            color: #00d4ff;
        }

        /* Fear & Greed */
        .fg-gauge {
            text-align: center;
        }

        .fg-value {
            font-size: 36px;
            font-weight: bold;
        }

        .fg-label {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .fg-bar {
            height: 20px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }

        .fg-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
            transition: width 1s ease;
        }

        /* Divergences - CHANGE 2026-01-30: Increased font size */
        .divergence-item {
            padding: 8px;
            margin: 4px 0;
            background: rgba(147, 51, 234, 0.1);
            border-left: 3px solid #9333ea;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Drawing Tools Panel */
        .drawing-tools {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .drawing-tools.collapsed {
            width: 45px;
            height: 45px;
            padding: 5px;
            overflow: hidden;
            cursor: pointer;
        }

        .drawing-tools.collapsed .tool-btn {
            display: none;
        }

        .tool-header {
            color: #ffd700;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .tool-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
            transform: scale(1.1);
        }

        .tool-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Trade Manager Panel */
        .trade-manager {
            position: fixed;
            top: 80px;
            left: 10px;
            z-index: 999;
            width: 320px;
            transition: width 0.3s ease;
        }

        .trade-manager.collapsed {
            width: 50px;
        }

        .trade-manager.collapsed .trade-panel {
            display: none;
        }

        .trade-manager.collapsed .trade-toggle {
            width: 50px;
            height: 50px;
        }

        .trade-toggle {
            width: 100%;
            height: 40px;
            background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
            transition: all 0.3s ease;
            color: #fff;
            font-weight: bold;
        }

        .trade-toggle:hover {
            box-shadow: 0 6px 20px rgba(0, 102, 255, 0.6);
            transform: translateY(-2px);
        }

        .trade-manager.collapsed .trade-toggle {
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }

        .trade-panel {
            margin-top: 10px;
            width: 100%;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            background: rgba(20, 20, 40, 0.98);
            border: 1px solid rgba(0, 102, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
            display: block;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .trade-panel h3 {
            color: #00d4ff;
            margin: 0 0 20px 0;
            text-align: center;
            font-size: 18px;
        }

        .trade-panel h4 {
            color: #fff;
            font-size: 14px;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 102, 255, 0.3);
        }

        /* Calculator Section */
        .calc-section, .sl-section, .quick-actions, .tp-section {
            margin-bottom: 20px;
        }

        .calc-row, .sl-row, .tp-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calc-row label, .sl-row label, .tp-row label {
            color: #aaa;
            font-size: 12px;
        }

        .calc-row input, .sl-row input, .tp-row input {
            width: 120px;
            padding: 6px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            text-align: right;
        }

        .calc-result {
            background: rgba(0, 102, 255, 0.1);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .calc-result div {
            color: #00d4ff;
            font-size: 12px;
            margin: 5px 0;
        }

        .calc-result span {
            float: right;
            font-weight: bold;
            color: #fff;
        }

        /* Stop Loss Modes */
        .sl-modes {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .sl-btn {
            flex: 1;
            padding: 8px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .sl-btn:hover {
            background: rgba(0, 102, 255, 0.2);
        }

        .sl-btn.active {
            background: rgba(0, 102, 255, 0.4);
            border-color: #00d4ff;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .quick-actions button {
            padding: 10px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(0, 102, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .quick-actions button:hover {
            background: rgba(0, 102, 255, 0.2);
            transform: translateY(-2px);
        }

        .apply-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #00d4ff, #0066ff);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
        }

        /* Theme Customizer Styles */
        .theme-customizer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-toggle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(20deg) scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .theme-panel {
            position: absolute;
            top: 60px;
            right: 0;
            width: 320px;
            background: rgba(20, 20, 40, 0.98);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 15px;
            padding: 20px;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .theme-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .theme-panel h3 {
            color: #fff;
            margin: 0 0 20px 0;
            font-size: 18px;
            text-align: center;
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .theme-section {
            margin-bottom: 20px;
        }

        .theme-section label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .theme-btn {
            padding: 8px 12px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .theme-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateY(-2px);
        }

        .theme-btn.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 1);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .color-picker span {
            color: #fff;
            font-family: monospace;
        }

        #fontSelect, #chartStyle {
            width: 100%;
            padding: 8px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .theme-actions button {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .theme-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Underglow Effects for Boxes */
        .underglow {
            position: relative;
            overflow: visible;
        }

        .underglow::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 10%;
            right: 10%;
            height: 20px;
            background: var(--underglow-color, linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff));
            filter: blur(20px);
            opacity: 0.6;
            z-index: -1;
            animation: underglow-pulse 3s ease-in-out infinite;
        }

        @keyframes underglow-pulse {
            0%, 100% { opacity: 0.4; transform: scaleX(0.8); }
            50% { opacity: 0.8; transform: scaleX(1); }
        }

        .panel-section.underglow::before {
            bottom: -5px;
            height: 30px;
            filter: blur(25px);
        }

        .stat-card.underglow::before {
            background: linear-gradient(90deg,
                var(--card-glow-1, #ff00ff),
                var(--card-glow-2, #00ffff));
            height: 15px;
            bottom: -3px;
            animation: underglow-shift 4s linear infinite;
        }

        @keyframes underglow-shift {
            0% { filter: blur(20px) hue-rotate(0deg); }
            100% { filter: blur(20px) hue-rotate(360deg); }
        }

        .indicator-overlay.underglow::before {
            background: linear-gradient(135deg, #ffd700, #ff6600, #ffd700);
            animation: underglow-breathe 2s ease-in-out infinite;
        }

        @keyframes underglow-breathe {
            0%, 100% {
                opacity: 0.3;
                filter: blur(15px);
            }
            50% {
                opacity: 0.7;
                filter: blur(25px);
            }
        }

        /* Theme-specific Underglow Colors */
        .theme-cyberpunk .underglow::before {
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff);
        }

        .theme-matrix .underglow::before {
            background: linear-gradient(90deg, #00ff00, #00cc00, #00ff00);
        }

        .theme-neon .underglow::before {
            background: linear-gradient(90deg, #ff00ff, #00ff00, #00ffff, #ff00ff);
        }

        .theme-ocean .underglow::before {
            background: linear-gradient(90deg, #006aff, #00d4ff, #006aff);
        }

        .theme-sunset .underglow::before {
            background: linear-gradient(90deg, #ff6600, #ff0066, #ff6600);
        }

        .theme-royal .underglow::before {
            background: linear-gradient(90deg, #9400d3, #ffd700, #9400d3);
        }

        .theme-hacker .underglow::before {
            background: linear-gradient(90deg, #00ff00, #00ff00);
            animation: underglow-flicker 0.5s infinite;
        }

        @keyframes underglow-flicker {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }

        /* High DPI / Retina Display Support */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .indicator-overlay {
                font-weight: 500;
            }
        }

        /* Landscape Orientation for Mobile */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .indicator-overlay {
                max-height: 30vh;
                top: 5px;
                left: 5px;
            }

            .chart-container {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Edge Analytics Panel -->
    <div class="edge-panel" id="edgePanel">
        <button class="edge-toggle" onclick="toggleEdgePanel()" title="Toggle Panel"></button>
        <div class="edge-header" onclick="toggleEdgePanel()"> EDGE ANALYTICS <span style="font-size:10px;opacity:0.7">(click to collapse)</span></div>
        <div class="edge-content">

        <!-- Liquidation Heatmap -->
        <div class="edge-section">
            <h4> Liquidation Levels</h4>
            <div class="liq-levels">
                <div class="liq-level long-liq">
                    <span>Long Liq Zone:</span>
                    <span class="liq-price" id="longLiqPrice">--</span>
                    <span class="liq-volume" id="longLiqVol">$0</span>
                </div>
                <div class="liq-level short-liq">
                    <span>Short Liq Zone:</span>
                    <span class="liq-price" id="shortLiqPrice">--</span>
                    <span class="liq-volume" id="shortLiqVol">$0</span>
                </div>
            </div>
            <canvas id="liqHeatmap" width="300" height="150"></canvas>
        </div>

        <!-- CVD - Cumulative Volume Delta -->
        <div class="edge-section">
            <h4> CVD (Order Flow)</h4>
            <div class="cvd-display">
                <div class="cvd-value" id="cvdValue">0</div>
                <div class="cvd-trend" id="cvdTrend">NEUTRAL</div>
                <canvas id="cvdChart" width="300" height="100"></canvas>
            </div>
        </div>

        <!-- Funding Rates -->
        <div class="edge-section">
            <h4> Funding Rates</h4>
            <div class="funding-display">
                <div class="funding-current">
                    <span>Current:</span>
                    <span class="funding-rate" id="currentFunding">0.01%</span>
                </div>
                <div class="funding-predicted">
                    <span>Predicted:</span>
                    <span class="funding-rate" id="predictedFunding">0.01%</span>
                </div>
                <div class="funding-signal" id="fundingSignal">NEUTRAL</div>
            </div>
        </div>

        <!-- Whale Alerts -->
        <div class="edge-section">
            <h4> Whale Activity</h4>
            <div class="whale-alerts" id="whaleAlerts">
                <div class="whale-item">Waiting for whales...</div>
            </div>
        </div>

        <!-- Market Internals -->
        <div class="edge-section">
            <h4> Market Internals</h4>
            <div class="internals">
                <div class="internal-item">
                    <span>Buy/Sell Ratio:</span>
                    <span id="buySellRatio">1.0</span>
                </div>
                <div class="internal-item">
                    <span>Aggressor Side:</span>
                    <span id="aggressorSide">NEUTRAL</span>
                </div>
                <div class="internal-item">
                    <span>Order Book Imbalance:</span>
                    <span id="bookImbalance">0%</span>
                </div>
                <div class="internal-item">
                    <span>Spread:</span>
                    <span id="spreadValue">0.01%</span>
                </div>
            </div>
        </div>

        <!-- On-Chain Metrics -->
        <div class="edge-section">
            <h4> On-Chain Edge</h4>
            <div class="onchain-metrics">
                <div class="metric-item">
                    <span>NVT Signal:</span>
                    <span id="nvtSignal" class="metric-value">--</span>
                </div>
                <div class="metric-item">
                    <span>MVRV:</span>
                    <span id="mvrvRatio" class="metric-value">--</span>
                </div>
                <div class="metric-item">
                    <span>SOPR:</span>
                    <span id="soprValue" class="metric-value">--</span>
                </div>
                <div class="metric-item">
                    <span>Exchange Reserve:</span>
                    <span id="exchangeReserve" class="metric-value">--</span>
                </div>
            </div>
        </div>

        <!-- Smart Money Tracking -->
        <div class="edge-section">
            <h4> Smart Money</h4>
            <div class="smart-money">
                <div class="smart-item">
                    <span>Smart Money Flow:</span>
                    <span id="smartFlow" class="flow-value">ACCUMULATING</span>
                </div>
                <div class="smart-item">
                    <span>Institutional Activity:</span>
                    <span id="instActivity">HIGH</span>
                </div>
                <div class="smart-item">
                    <span>Old Coins Moving:</span>
                    <span id="dormancy">LOW</span>
                </div>
            </div>
        </div>

        <!-- Fear & Greed Index -->
        <div class="edge-section">
            <h4> Fear & Greed</h4>
            <div class="fear-greed">
                <div class="fg-gauge">
                    <div class="fg-value" id="fgValue">50</div>
                    <div class="fg-label" id="fgLabel">NEUTRAL</div>
                    <div class="fg-bar">
                        <div class="fg-fill" id="fgFill" style="width: 50%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Divergences -->
        <div class="edge-section">
            <h4> Hidden Divergences</h4>
            <div class="divergences" id="divergences">
                <div class="divergence-item">Scanning...</div>
            </div>
        </div>
        </div><!-- end edge-content -->
    </div>

    <!-- Drawing Tools Panel -->
    <div class="drawing-tools collapsed" id="drawingTools" onclick="if(this.classList.contains('collapsed')) this.classList.remove('collapsed')">
        <div class="tool-header"><button class="edge-toggle" onclick="event.stopPropagation(); document.getElementById('drawingTools').classList.add('collapsed')" style="margin-left:5px"></button></div>
        <button class="tool-btn" onclick="activateDrawingTool('trendline')" title="Trend Line"></button>
        <button class="tool-btn" onclick="activateDrawingTool('horizontal')" title="Horizontal Line"></button>
        <button class="tool-btn" onclick="activateDrawingTool('vertical')" title="Vertical Line"></button>
        <button class="tool-btn" onclick="activateDrawingTool('rectangle')" title="Rectangle"></button>
        <button class="tool-btn" onclick="activateDrawingTool('fibonacci')" title="Fibonacci"></button>
        <button class="tool-btn" onclick="activateDrawingTool('arrow')" title="Arrow"></button>
        <button class="tool-btn" onclick="activateDrawingTool('text')" title="Text">T</button>
        <button class="tool-btn" onclick="clearDrawings()" title="Clear All"></button>
    </div>

    <!-- Trade Management Panel -->
    <div class="trade-manager" id="tradeManager">
        <div class="trade-toggle" onclick="toggleTradeManager()"> TRADE MANAGER <span style="font-size:11px;opacity:0.7">(click to collapse)</span></div>
        <div class="trade-panel active" id="tradePanel">
            <h3>Trade Management</h3>

            <!-- Position Calculator -->
            <div class="calc-section">
                <h4>Position Calculator</h4>
                <div class="calc-row">
                    <label>Account Balance:</label>
                    <input type="number" id="accountBalance" value="10000" onchange="calculatePosition()">
                </div>
                <div class="calc-row">
                    <label>Risk %:</label>
                    <input type="number" id="riskPercent" value="1" step="0.1" onchange="calculatePosition()">
                </div>
                <div class="calc-row">
                    <label>Entry Price:</label>
                    <input type="number" id="entryPrice" step="0.01" onchange="calculatePosition()">
                </div>
                <div class="calc-row">
                    <label>Stop Loss:</label>
                    <input type="number" id="stopLoss" step="0.01" onchange="calculatePosition()">
                </div>
                <div class="calc-result">
                    <div>Position Size: <span id="positionSize">0</span></div>
                    <div>Risk Amount: <span id="riskAmount">$0</span></div>
                    <div>Risk/Reward: <span id="riskReward">0:0</span></div>
                </div>
            </div>

            <!-- Stop Loss Manager -->
            <div class="sl-section">
                <h4>Stop Loss Manager</h4>
                <div class="sl-modes">
                    <button class="sl-btn" onclick="setSLMode('fixed')">Fixed SL</button>
                    <button class="sl-btn" onclick="setSLMode('trailing')">Trailing SL</button>
                    <button class="sl-btn" onclick="setSLMode('breakeven')">Breakeven</button>
                </div>
                <div class="sl-settings">
                    <div class="sl-row">
                        <label>Current SL:</label>
                        <input type="number" id="currentSL" step="0.01">
                    </div>
                    <div class="sl-row">
                        <label>Trail Distance:</label>
                        <input type="number" id="trailDistance" value="50" step="1">
                    </div>
                    <div class="sl-row">
                        <label>Move to BE at:</label>
                        <input type="number" id="beTarget" value="100" step="1">
                    </div>
                </div>
                <button class="apply-btn" onclick="applyStopLoss()">Apply Changes</button>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h4>Quick Actions</h4>
                <button onclick="closeHalf()">Close 50%</button>
                <button onclick="closeAll()">Close All</button>
                <button onclick="reversePosition()">Reverse</button>
                <button onclick="hedgePosition()">Hedge</button>
            </div>

            <!-- Take Profit Targets -->
            <div class="tp-section">
                <h4>Take Profit Targets</h4>
                <div class="tp-row">
                    <label>TP1 (25%):</label>
                    <input type="number" id="tp1" step="0.01">
                </div>
                <div class="tp-row">
                    <label>TP2 (50%):</label>
                    <input type="number" id="tp2" step="0.01">
                </div>
                <div class="tp-row">
                    <label>TP3 (25%):</label>
                    <input type="number" id="tp3" step="0.01">
                </div>
                <button class="apply-btn" onclick="setTakeProfits()">Set Targets</button>
            </div>
        </div>
    </div>

    <!-- Theme Customizer -->
    <div class="theme-customizer" id="themeCustomizer">
        <div class="theme-toggle" onclick="toggleThemePanel()"></div>
        <div class="theme-panel" id="themePanel">
            <h3>Customize Your Dashboard</h3>

            <!-- Theme Presets -->
            <div class="theme-section">
                <label>Theme</label>
                <div class="theme-options">
                    <button class="theme-btn" data-theme="cyberpunk" onclick="applyTheme('cyberpunk')"> Cyberpunk</button>
                    <button class="theme-btn" data-theme="matrix" onclick="applyTheme('matrix')"> Matrix</button>
                    <button class="theme-btn" data-theme="neon" onclick="applyTheme('neon')"> Neon</button>
                    <button class="theme-btn" data-theme="dark" onclick="applyTheme('dark')"> Dark</button>
                    <button class="theme-btn" data-theme="ocean" onclick="applyTheme('ocean')"> Ocean</button>
                    <button class="theme-btn" data-theme="sunset" onclick="applyTheme('sunset')"> Sunset</button>
                    <button class="theme-btn" data-theme="royal" onclick="applyTheme('royal')"> Royal</button>
                    <button class="theme-btn" data-theme="hacker" onclick="applyTheme('hacker')"> Hacker</button>
                </div>
            </div>

            <!-- Accent Color -->
            <div class="theme-section">
                <label>Accent Color</label>
                <div class="color-picker">
                    <input type="color" id="accentColor" onchange="updateAccentColor(this.value)">
                    <span id="colorValue">#FFD700</span>
                </div>
            </div>

            <!-- Font Selection -->
            <div class="theme-section">
                <label>Font</label>
                <select id="fontSelect" onchange="updateFont(this.value)">
                    <option value="monospace">Monospace</option>
                    <option value="'Courier New'">Courier New</option>
                    <option value="'Roboto Mono'">Roboto Mono</option>
                    <option value="'Fira Code'">Fira Code</option>
                    <option value="'JetBrains Mono'">JetBrains Mono</option>
                    <option value="'SF Mono'">SF Mono</option>
                    <option value="Arial">Arial</option>
                    <option value="'Segoe UI'">Segoe UI</option>
                </select>
            </div>

            <!-- Chart Style -->
            <div class="theme-section">
                <label>Chart Style</label>
                <select id="chartStyle" onchange="updateChartStyle(this.value)">
                    <option value="candlestick">Candlestick</option>
                    <option value="line">Line</option>
                    <option value="area">Area</option>
                    <option value="bars">Bars</option>
                </select>
            </div>

            <!-- Animations -->
            <div class="theme-section">
                <label>Animations</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="animToggle" checked onchange="toggleAnimations(this.checked)">
                    <label for="animToggle">Enable</label>
                </div>
            </div>

            <!-- Save/Reset -->
            <div class="theme-actions">
                <button onclick="saveTheme()"> Save</button>
                <button onclick="resetTheme()"> Reset</button>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="logo">OGZPrime</div>
        <div class="tagline">Neural Ensemble  Real-Time Data</div>
        <div class="tier-selector-container">
            <span class="tier-label">SELECT VERSION:</span>
            <select id="tierSelector" class="tier-selector" onchange="switchTier(this.value)">
                <option value="ml"> ML VERSION - ALL FEATURES</option>
                <option value="core"> CORE VERSION</option>
            </select>
            <div class="connection-status">
                <span class="status-dot" id="connectionStatus"></span>
                <span id="statusText">Connecting...</span>
            </div>

            <!-- CHANGE 2026-01-22: Multi-status lights for system health -->
            <div class="status-lights-bar">
                <div class="status-light" title="Kraken data feed">
                    <span class="light" id="dataLight"></span>
                    <span class="label">DATA</span>
                </div>
                <div class="status-light" title="Trading bot process">
                    <span class="light" id="botLight"></span>
                    <span class="label">BOT</span>
                </div>
                <div class="status-light" title="TRAI LLM inference">
                    <span class="light" id="traiLight"></span>
                    <span class="label">TRAI</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Unified Chart Section -->
        <div class="unified-chart-section tier-ml" id="unifiedChart">
            <div class="chart-header">
                <div class="chart-title-container">
                    <h2 class="chart-title" id="chartTitle">ML VERSION</h2>
                    <span class="price-display" id="currentPrice">$0.00</span>
                </div>
                <div class="chart-controls">
                    <select id="chartTypeSelector" onchange="changeChartType(this.value)">
                        <option value="candlestick" selected>Candlestick</option>
                        <option value="line">Line</option>
                    </select>
                    <select id="assetSelector" onchange="changeAsset(this.value)">
                        <option value="BTC-USD" selected>Bitcoin (BTC)</option>
                        <option value="ETH-USD">Ethereum (ETH)</option>
                        <option value="SOL-USD">Solana (SOL)</option>
                        <option value="XRP-USD">Ripple (XRP)</option>
                        <option value="ADA-USD">Cardano (ADA)</option>
                        <option value="DOT-USD">Polkadot (DOT)</option>
                        <option value="AVAX-USD">Avalanche (AVAX)</option>
                        <option value="LINK-USD">Chainlink (LINK)</option>
                        <option value="MATIC-USD">Polygon (MATIC)</option>
                        <option value="UNI-USD">Uniswap (UNI)</option>
                        <option value="ATOM-USD">Cosmos (ATOM)</option>
                        <option value="LTC-USD">Litecoin (LTC)</option>
                        <option value="DOGE-USD">Dogecoin (DOGE)</option>
                        <option value="SHIB-USD">Shiba Inu (SHIB)</option>
                        <option value="APT-USD">Aptos (APT)</option>
                    </select>
                    <select id="timeframeSelector" onchange="changeTimeframe(this.value)">
                        <option value="1m" selected>1M</option>
                        <option value="5m">5M</option>
                        <option value="15m">15M</option>
                        <option value="30m">30M</option>
                        <option value="1h">1H</option>
                        <option value="4h">4H</option>
                        <option value="1d">1D</option>
                    </select>
                    <div class="indicator-checkboxes" id="indicatorCheckboxes">
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-ema" value="ema" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ffcc00;"></span>
                            <span>EMA</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-sma" value="sma" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #00ccff;"></span>
                            <span>SMA</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-bollinger" value="bollinger" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ff00cc;"></span>
                            <span>Bollinger Bands</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-atr" value="atr" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ff6600;"></span>
                            <span>ATR</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-fibonacci" value="fibonacci" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #9900ff;"></span>
                            <span>Fibonacci</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-trendlines" value="trendlines" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #00ff00;"></span>
                            <span>Trend Lines</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-rsi" value="rsi" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ff0066;"></span>
                            <span>RSI Overlay</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-macd" value="macd" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #6600ff;"></span>
                            <span>MACD Overlay</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-vwap" value="vwap" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #00ffcc;"></span>
                            <span>VWAP</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-ichimoku" value="ichimoku" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ccff00;"></span>
                            <span>Ichimoku Cloud</span>
                        </label>
                        <label class="indicator-check">
                            <input type="checkbox" id="chk-sr" value="sr" onchange="updateIndicatorOverlays()">
                            <span class="color-dot" style="background: #ff9900;"></span>
                            <span>Support/Resistance</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <!-- TradingView Chart -->
                <div id="tvChartContainer"></div>
                
                <!-- Dynamic Indicator Overlay -->
                <div class="indicator-overlay" id="indicatorOverlay">
                    <h4> Indicators</h4>

                    <!-- Core Indicators -->
                    <div class="indicators-panel core-indicators">
                        <div class="indicator-item">
                            <span class="indicator-label">RSI (14):</span>
                            <span class="indicator-value" id="rsiCore">50</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">MACD (12/26):</span>
                            <span class="indicator-value" id="macdCore">0.00</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">Pattern:</span>
                            <span class="indicator-value" id="patternCore">None</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">Volume:</span>
                            <span class="indicator-value" id="volumeCore">0</span>
                        </div>
                    </div>

                    <!-- ML Indicators (Full suite) -->
                    <div class="indicators-panel ml-indicators">
                        <div class="indicator-item">
                            <span class="indicator-label">RSI (14):</span>
                            <span class="indicator-value" id="rsiML">50</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">MACD (12/26):</span>
                            <span class="indicator-value" id="macdML">0.00</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">Pattern:</span>
                            <span class="indicator-value" id="patternML">None</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">Volume:</span>
                            <span class="indicator-value" id="volumeML">0</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">ATR:</span>
                            <span class="indicator-value" id="atrML">0.00</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-label">Confidence:</span>
                            <span class="indicator-value" id="confidenceML">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trading Panel -->
        <div class="trading-panel">
            <!-- CHANGE 2026-01-29: Trading Controls commented out - this is a PROOF display, not trading interface
            <div class="panel-section">
                <div class="panel-title">Trading Controls</div>
                <div class="trade-controls">
                    <button class="trade-btn buy-btn" onclick="executeTrade('buy')">BUY</button>
                    <button class="trade-btn sell-btn" onclick="executeTrade('sell')">SELL</button>
                    <button class="trade-btn kill-btn" onclick="executeTrade('kill')">KILL</button>
                </div>
                <div class="trade-controls">
                    <button class="trade-btn long-btn" onclick="executeTrade('long')">LONG</button>
                    <button class="trade-btn short-btn" onclick="executeTrade('short')">SHORT</button>
                    <button class="trade-btn hedge-btn" onclick="executeTrade('hedge')">HEDGE</button>
                </div>
                <div class="trade-controls" style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                    <button class="trade-btn pause-btn" id="pauseBtn" onclick="pauseTrading()" style="background: linear-gradient(135deg, #f59e0b, #d97706);"> PAUSE</button>
                    <button class="trade-btn resume-btn" id="resumeBtn" onclick="resumeTrading()" style="background: linear-gradient(135deg, #10b981, #059669); display: none;"> RESUME</button>
                </div>
                <div id="pauseStatus" style="font-size: 11px; color: #f59e0b; margin-top: 5px; display: none;">
                    <span id="pauseReason"></span>
                </div>
            </div>
            END TRADING CONTROLS -->

            <!-- Pattern Recognition Section -->
            <div class="panel-section">
                <!-- Pattern Recognition Panel -->
                <div class="pattern-panel">
                    <div class="panel-title">Pattern Analysis</div>
                    <div class="pattern-display" id="patternDisplay">
                        <div class="pattern-name" id="currentPatternName">Analyzing...</div>
                        <!-- CHANGE 2026-01-30: SVG replaces canvas for pattern visualization -->
                        <div class="pattern-visual" id="patternVisual">
                            <svg viewBox="0 0 200 80" style="width:100%;height:80px"><circle cx="80" cy="35" r="20" stroke="#888" fill="none" stroke-width="2"/><line x1="95" y1="50" x2="120" y2="70" stroke="#888" stroke-width="4" stroke-linecap="round"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Scanning...</text></svg>
                        </div>
                        <div class="pattern-description" id="patternDescription">
                            <p class="pattern-info">Pattern detection active. When a pattern is identified, its visual representation and explanation will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="panel-section">
                <div class="panel-title">Performance Stats</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total P&L</div>
                        <div class="stat-value" id="totalPnl">$0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Trades Executed</div>
                        <div class="stat-value" id="tradesExecuted">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Confidence</div>
                        <div class="stat-value" id="confidence">0%</div>
                    </div>
                </div>

                <!-- Trade Log -->
                <div class="panel-title">Trade Log</div>
                <div class="trade-log" id="tradeLog">
                </div>
            </div>
            
            <!-- Chain of Thought Section -->
            <div class="panel-section">
                <div class="panel-title">Chain of Thought</div>
                <div class="chain-of-thought" id="chainOfThought">
                    <div class="thought-entry" id="thoughtDisplay">
                        <p>Awaiting market data...</p>
                    </div>
                </div>

                <!-- CHANGE 2026-01-29: Neural Ensemble Voting commented out for now
                <div class="neural-ensemble">
                    <div class="panel-title">Neural Ensemble Voting</div>
                    <div class="ensemble-grid">
                        <div class="brain-module">
                            <div class="brain-name">Technical</div>
                            <div class="brain-vote vote-hold" id="technicalVote">HOLD</div>
                            <div class="brain-confidence" id="technicalConf">0%</div>
                        </div>
                        <div class="brain-module">
                            <div class="brain-name">Pattern</div>
                            <div class="brain-vote vote-hold" id="patternVote">HOLD</div>
                            <div class="brain-confidence" id="patternConf">0%</div>
                        </div>
                        <div class="brain-module">
                            <div class="brain-name">Momentum</div>
                            <div class="brain-vote vote-hold" id="momentumVote">HOLD</div>
                            <div class="brain-confidence" id="momentumConf">0%</div>
                        </div>
                        <div class="brain-module">
                            <div class="brain-name">Risk</div>
                            <div class="brain-vote vote-hold" id="riskVote">HOLD</div>
                            <div class="brain-confidence" id="riskConf">0%</div>
                        </div>
                        <div class="brain-module">
                            <div class="brain-name">Ensemble</div>
                            <div class="brain-vote vote-hold" id="ensembleVote">HOLD</div>
                            <div class="brain-confidence" id="ensembleConf">0%</div>
                        </div>
                    </div>
                </div>
                END NEURAL ENSEMBLE -->
            </div>
        </div>
    </div>
    
    <!-- Upgrade Prompt -->
    <div class="upgrade-prompt" onclick="showUpgradeOptions()" style="display: none;">
        Contact for ML Version Access
    </div>
    
    <script>
        // ============================================
        // OGZPrime Dashboard - Complete TradingView Edition
        // All original functionality + TradingView charts + Indicator overlays
        // ============================================
        
        console.log(' OGZPrime Dashboard Loading...');
        
        // Global state
        let ws = null;
        let tvChart = null;
        let currentTier = 'ml';
        let tradesExecuted = 0;
        let lastPrice = 0;
        let currentChartType = 'candlestick';
        
        // Chart series
        let candleSeries = null;
        let lineSeries = null;
        let volumeSeries = null;
        
        // Indicator overlay series
        let ema20Series = null;
        let ema50Series = null;
        let ema200Series = null;
        let bbUpperSeries = null;
        let bbMiddleSeries = null;
        let bbLowerSeries = null;
        let vwapSeries = null;
        let superTrendSeries = null;
        
        // Active indicator overlays (all OFF by default - user preference)
        let activeOverlays = [];
        let autoScrollEnabled = true;  // Auto-scroll to follow price
        
        let botStates = {
            core: { connected: false, pnl: 0, trades: 0, confidence: 0 },
            ml: { connected: false, pnl: 0, trades: 0, confidence: 0 }
        };

        // Version configurations
        const tierConfigs = {
            core: {
                title: 'CORE VERSION',
                indicators: ['RSI', 'MACD', 'Pattern', 'Volume'],
                features: {
                    patterns: true,
                    neural: false,
                    chainOfThought: false
                }
            },
            ml: {
                title: 'ML VERSION',
                indicators: ['RSI', 'MACD', 'Pattern', 'Volume', 'ATR', 'Confidence', 'All Overlays'],
                features: {
                    patterns: true,
                    neural: true,
                    chainOfThought: true
                }
            }
        };

        // Trade button colors
        const tradeColors = {
            buy: '#00ff41',
            sell: '#ff4444',
            kill: '#ff6600',
            long: '#1e90ff',
            short: '#9400d3',
            hedge: '#ff8c00'
        };
        
        // Indicator colors
        const COLORS = {
            ema20: '#ffcc00',
            ema50: '#00ccff',
            ema200: '#ff6600',
            bbUpper: 'rgba(255, 255, 255, 0.4)',
            bbMiddle: 'rgba(255, 255, 255, 0.6)',
            bbLower: 'rgba(255, 255, 255, 0.4)',
            vwap: '#ff00ff',
            superTrendUp: '#00ff88',
            superTrendDown: '#ff3366'
        };

        // CHANGE 2026-01-29: Pattern descriptions for customer education
        const PATTERN_DESCRIPTIONS = {
            // Bullish patterns
            'double_bottom': {
                emoji: '',
                name: 'Double Bottom',
                description: 'Price bounced twice from the same support level, signaling buyers are stepping in. Often precedes upward movement.'
            },
            'ascending_triangle': {
                emoji: '',
                name: 'Ascending Triangle',
                description: 'Higher lows forming against a flat resistance. Buying pressure increasing - typically breaks upward.'
            },
            'bullish_engulfing': {
                emoji: '',
                name: 'Bullish Engulfing',
                description: 'Large green candle completely engulfs previous red candle. Strong reversal signal showing buyers taking control.'
            },
            'morning_star': {
                emoji: '',
                name: 'Morning Star',
                description: 'Three-candle reversal pattern: down candle, small body, then up candle. Dawn of a new uptrend.'
            },
            'hammer': {
                emoji: '',
                name: 'Hammer',
                description: 'Long lower wick with small body at top. Sellers pushed price down but buyers fought back hard.'
            },
            'inverse_head_shoulders': {
                emoji: '',
                name: 'Inverse Head & Shoulders',
                description: 'Three troughs with middle lowest. Classic bottoming pattern - neckline break triggers rally.'
            },
            // Bearish patterns
            'double_top': {
                emoji: '',
                name: 'Double Top',
                description: 'Price rejected twice from same resistance level. Buyers exhausted - often precedes decline.'
            },
            'descending_triangle': {
                emoji: '',
                name: 'Descending Triangle',
                description: 'Lower highs against flat support. Selling pressure building - typically breaks downward.'
            },
            'bearish_engulfing': {
                emoji: '',
                name: 'Bearish Engulfing',
                description: 'Large red candle completely engulfs previous green. Strong reversal showing sellers taking control.'
            },
            'evening_star': {
                emoji: '',
                name: 'Evening Star',
                description: 'Three-candle reversal: up candle, small body, then down candle. End of day for the uptrend.'
            },
            'shooting_star': {
                emoji: '',
                name: 'Shooting Star',
                description: 'Long upper wick with small body at bottom. Buyers pushed up but sellers slammed it back down.'
            },
            'head_shoulders': {
                emoji: '',
                name: 'Head & Shoulders',
                description: 'Three peaks with middle highest. Classic topping pattern - neckline break triggers decline.'
            },
            // Continuation patterns
            'flag': {
                emoji: '',
                name: 'Flag Pattern',
                description: 'Brief consolidation after strong move. Price resting before continuing in same direction.'
            },
            'pennant': {
                emoji: '',
                name: 'Pennant',
                description: 'Triangular consolidation after strong move. Coiling before explosive breakout continuation.'
            },
            'wedge': {
                emoji: '',
                name: 'Wedge Pattern',
                description: 'Converging trendlines showing compression. Breakout direction confirms next major move.'
            },
            // Learning patterns
            'learning_pattern': {
                emoji: '',
                name: 'Learning Pattern',
                description: 'AI has detected a pattern from historical memory. Confidence based on similar past outcomes.'
            },
            // Default
            'unknown': {
                emoji: '',
                name: 'Analyzing',
                description: 'Scanning market structure for recognizable patterns...'
            }
        };

        // Helper to get pattern info
        function getPatternInfo(patternName) {
            if (!patternName) return PATTERN_DESCRIPTIONS['unknown'];
            const key = patternName.toLowerCase().replace(/[^a-z_]/g, '_');
            return PATTERN_DESCRIPTIONS[key] || PATTERN_DESCRIPTIONS['unknown'];
        }

        // CHANGE 2026-01-30: Pattern SVG visualizations for visual learning
        const PATTERN_SVGS = {
            'double_bottom': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M10 20 L50 65 L90 20 L130 65 L170 10" stroke="#00ff88" fill="none" stroke-width="3"/><line x1="10" y1="65" x2="190" y2="65" stroke="#00ff88" stroke-dasharray="5,5" opacity="0.5"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Support</text></svg>',
            'double_top': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M10 60 L50 15 L90 60 L130 15 L170 70" stroke="#ff4444" fill="none" stroke-width="3"/><line x1="10" y1="15" x2="190" y2="15" stroke="#ff4444" stroke-dasharray="5,5" opacity="0.5"/><text x="100" y="12" fill="#888" font-size="10" text-anchor="middle">Resistance</text></svg>',
            'ascending_triangle': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><line x1="10" y1="15" x2="190" y2="15" stroke="#ffd700" stroke-width="2"/><path d="M10 70 L60 50 L110 35 L160 20 L190 10" stroke="#00ff88" fill="none" stroke-width="3"/><text x="100" y="78" fill="#00ff88" font-size="10" text-anchor="middle">Higher Lows </text></svg>',
            'descending_triangle': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><line x1="10" y1="65" x2="190" y2="65" stroke="#ffd700" stroke-width="2"/><path d="M10 15 L60 30 L110 45 L160 58 L190 70" stroke="#ff4444" fill="none" stroke-width="3"/><text x="100" y="12" fill="#ff4444" font-size="10" text-anchor="middle">Lower Highs </text></svg>',
            'bullish_engulfing': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><rect x="50" y="30" width="30" height="35" fill="#ff4444" rx="2"/><rect x="100" y="15" width="40" height="55" fill="#00ff88" rx="2"/><text x="100" y="78" fill="#00ff88" font-size="10" text-anchor="middle">Buyers Take Control</text></svg>',
            'bearish_engulfing': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><rect x="50" y="25" width="30" height="35" fill="#00ff88" rx="2"/><rect x="100" y="10" width="40" height="55" fill="#ff4444" rx="2"/><text x="100" y="78" fill="#ff4444" font-size="10" text-anchor="middle">Sellers Take Control</text></svg>',
            'hammer': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><line x1="100" y1="70" x2="100" y2="30" stroke="#00ff88" stroke-width="3"/><rect x="85" y="15" width="30" height="18" fill="#00ff88" rx="2"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Reversal Signal</text></svg>',
            'shooting_star': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><line x1="100" y1="10" x2="100" y2="50" stroke="#ff4444" stroke-width="3"/><rect x="85" y="48" width="30" height="18" fill="#ff4444" rx="2"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Reversal Signal</text></svg>',
            'head_shoulders': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M10 60 L40 35 L70 55 L100 10 L130 55 L160 35 L190 65" stroke="#ff4444" fill="none" stroke-width="3"/><line x1="40" y1="55" x2="160" y2="55" stroke="#ffd700" stroke-dasharray="5,5"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Neckline</text></svg>',
            'inverse_head_shoulders': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M10 20 L40 45 L70 25 L100 70 L130 25 L160 45 L190 15" stroke="#00ff88" fill="none" stroke-width="3"/><line x1="40" y1="25" x2="160" y2="25" stroke="#ffd700" stroke-dasharray="5,5"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Neckline</text></svg>',
            'flag': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M20 70 L60 15" stroke="#00ff88" stroke-width="4"/><path d="M60 15 L80 25 L100 18 L120 28 L140 22" stroke="#ffd700" fill="none" stroke-width="2"/><path d="M140 22 L180 5" stroke="#00ff88" stroke-width="2" stroke-dasharray="5,5"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Continuation</text></svg>',
            'pennant': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M20 70 L60 20" stroke="#00ff88" stroke-width="4"/><path d="M60 15 L110 35 M60 40 L110 35" stroke="#ffd700" fill="none" stroke-width="2"/><path d="M110 35 L180 5" stroke="#00ff88" stroke-width="2" stroke-dasharray="5,5"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Compression</text></svg>',
            'wedge': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><path d="M20 15 L160 40" stroke="#ff4444" stroke-width="2"/><path d="M20 65 L160 40" stroke="#00ff88" stroke-width="2"/><circle cx="160" cy="40" r="8" fill="#ffd700" opacity="0.8"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Breakout Point</text></svg>',
            'morning_star': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><rect x="30" y="15" width="25" height="40" fill="#ff4444" rx="2"/><rect x="85" y="45" width="15" height="12" fill="#888" rx="2"/><rect x="130" y="20" width="25" height="40" fill="#00ff88" rx="2"/><text x="100" y="78" fill="#00ff88" font-size="10" text-anchor="middle">Bullish Reversal</text></svg>',
            'evening_star': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><rect x="30" y="25" width="25" height="40" fill="#00ff88" rx="2"/><rect x="85" y="18" width="15" height="12" fill="#888" rx="2"/><rect x="130" y="20" width="25" height="40" fill="#ff4444" rx="2"/><text x="100" y="78" fill="#ff4444" font-size="10" text-anchor="middle">Bearish Reversal</text></svg>',
            'learning_pattern': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><circle cx="100" cy="35" r="25" stroke="#00d4ff" fill="none" stroke-width="2"/><path d="M80 35 Q100 15 120 35 Q100 55 80 35" stroke="#00d4ff" fill="rgba(0,212,255,0.2)"/><circle cx="100" cy="35" r="8" fill="#00d4ff"/><text x="100" y="78" fill="#00d4ff" font-size="10" text-anchor="middle">AI Pattern Memory</text></svg>',
            'unknown': '<svg viewBox="0 0 200 80" style="width:100%;height:80px"><circle cx="80" cy="35" r="20" stroke="#888" fill="none" stroke-width="2"/><line x1="95" y1="50" x2="120" y2="70" stroke="#888" stroke-width="4" stroke-linecap="round"/><text x="100" y="78" fill="#888" font-size="10" text-anchor="middle">Scanning...</text></svg>'
        };

        // Helper to get pattern SVG
        function getPatternSVG(patternName) {
            if (!patternName) return PATTERN_SVGS['unknown'];
            const key = patternName.toLowerCase().replace(/[^a-z_]/g, '_');
            return PATTERN_SVGS[key] || PATTERN_SVGS['unknown'];
        }

        // ============================================
        // CHART INITIALIZATION
        // ============================================

        // CHANGE 2026-01-29: Convert UTC timestamp to local time for chart display
        // Lightweight Charts treats all timestamps as UTC internally, so we need to
        // convert to "fake UTC" that will display as local time
        // See: https://tradingview.github.io/lightweight-charts/docs/time-zones
        function timeToLocal(utcTimestamp) {
            const d = new Date(utcTimestamp * 1000);
            return Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(),
                           d.getHours(), d.getMinutes(), d.getSeconds()) / 1000;
        }

        function initChart() {
            console.log(' [Chart] Initializing TradingView chart...');
            
            if (typeof LightweightCharts === 'undefined') {
                console.error(' LightweightCharts not loaded!');
                return;
            }
            
            const container = document.getElementById('tvChartContainer');
            if (!container) {
                console.error(' Chart container not found!');
                return;
            }
            
            const rect = container.parentElement.getBoundingClientRect();
            
            tvChart = LightweightCharts.createChart(container, {
                width: rect.width - 20,
                height: rect.height - 20,
                layout: {
                    background: { type: 'solid', color: '#0a0a0a' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: 'rgba(255, 255, 255, 0.06)' },
                    horzLines: { color: 'rgba(255, 255, 255, 0.06)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: {
                        color: 'rgba(255, 215, 0, 0.4)',
                        width: 1,
                        style: 2,
                        labelVisible: true,
                    },
                    horzLine: { color: 'rgba(255, 215, 0, 0.4)', width: 1, style: 2 },
                },
                rightPriceScale: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    scaleMargins: { top: 0.05, bottom: 0.15 },  // Less padding
                    autoScale: true,
                    alignLabels: true,  // Align price labels to candle closes
                    entireTextOnly: true,  // Don't cut off price labels
                },
                timeScale: {
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    timeVisible: true,
                    secondsVisible: false,
                    barSpacing: 8,  // CHANGE 2026-01-23: Thinner candles (default ~6, was too fat)
                    minBarSpacing: 2,  // Allow zooming in closer
                    rightOffset: 5,  // Keep some space on right for new candles
                    // CHANGE 2026-01-21: Fix timezone - show local time, not UTC
                    // The chart receives Unix timestamps in seconds (UTC)
                    // This tells the chart to display them in local time
                    localization: {
                        locale: navigator.language || 'en-US',
                    },
                },
                localization: {
                    priceFormatter: price => '$' + price.toFixed(2),
                    // CHANGE 2026-01-30: Use getUTC* since timestamps are pre-converted via timeToLocal()
                    // Format: "Jan 29 16:37" - compact date + time for all timeframes
                    timeFormatter: (timestamp) => {
                        const date = new Date(timestamp * 1000);
                        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        const month = months[date.getUTCMonth()];
                        const day = date.getUTCDate();
                        const hours = date.getUTCHours().toString().padStart(2, '0');
                        const minutes = date.getUTCMinutes().toString().padStart(2, '0');
                        return `${month} ${day} ${hours}:${minutes}`;
                    },
                },
                handleScroll: {
                    mouseWheel: false,  // CHANGE 2026-01-22: Disable janky mousewheel zoom
                    pressedMouseMove: true,  // Click and drag to pan
                    horzTouchDrag: true,
                    vertTouchDrag: false,  // Don't scroll price axis
                },
                handleScale: {
                    mouseWheel: false,  // CHANGE 2026-01-22: Disable mousewheel scale
                    pinch: true,  // Keep pinch zoom for touch devices
                    axisPressedMouseMove: false,  // Disable axis drag zoom (was confusing)
                    axisDoubleClickReset: true,  // Double-click axis to reset zoom
                },
            });
            
            // Main price series
            candleSeries = tvChart.addCandlestickSeries({
                upColor: 'rgba(0, 255, 136, 0.8)',
                downColor: 'rgba(255, 51, 102, 0.8)',
                borderVisible: true,
                borderUpColor: '#00ff88',
                borderDownColor: '#ff3366',
                wickUpColor: '#00ff88',
                wickDownColor: '#ff3366',
                priceFormat: {
                    type: 'price',
                    precision: 2,
                    minMove: 0.01
                }
            });
            
            lineSeries = tvChart.addLineSeries({
                color: '#00ff88',
                lineWidth: 2,
                visible: false,
            });
            
            // CHANGE 2026-01-22: Fix volume bars - use named overlay scale
            volumeSeries = tvChart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: 'volume',  // Named scale for volume
            });

            // Configure volume scale to appear at bottom 15% of chart
            tvChart.priceScale('volume').applyOptions({
                scaleMargins: {
                    top: 0.85,
                    bottom: 0,
                },
            });
            
            // EMA lines
            ema20Series = tvChart.addLineSeries({
                color: COLORS.ema20,
                lineWidth: 1,
                visible: activeOverlays.includes('ema'),
            });
            
            ema50Series = tvChart.addLineSeries({
                color: COLORS.ema50,
                lineWidth: 1,
                visible: activeOverlays.includes('ema'),
            });
            
            ema200Series = tvChart.addLineSeries({
                color: COLORS.ema200,
                lineWidth: 2,
                visible: activeOverlays.includes('ema'),
            });
            
            // Bollinger Bands
            bbUpperSeries = tvChart.addLineSeries({
                color: COLORS.bbUpper,
                lineWidth: 1,
                visible: activeOverlays.includes('bollinger'),
                lineStyle: 2,
            });
            
            bbMiddleSeries = tvChart.addLineSeries({
                color: COLORS.bbMiddle,
                lineWidth: 1,
                visible: activeOverlays.includes('bollinger'),
            });
            
            bbLowerSeries = tvChart.addLineSeries({
                color: COLORS.bbLower,
                lineWidth: 1,
                visible: activeOverlays.includes('bollinger'),
                lineStyle: 2,
            });
            
            // VWAP
            vwapSeries = tvChart.addLineSeries({
                color: COLORS.vwap,
                lineWidth: 2,
                visible: activeOverlays.includes('vwap'),
            });
            
            // SuperTrend
            superTrendSeries = tvChart.addLineSeries({
                color: COLORS.superTrendUp,
                lineWidth: 2,
                visible: false,
            });
            
            // Resize handler
            window.addEventListener('resize', () => {
                if (tvChart) {
                    const r = container.parentElement.getBoundingClientRect();
                    tvChart.applyOptions({ width: r.width - 20, height: r.height - 20 });
                }
            });
            
            window.tvChart = tvChart;
            window.candleSeries = candleSeries;

            // Add crosshair move handler for OHLC display
            tvChart.subscribeCrosshairMove((param) => {
                if (!param || !param.seriesData || !param.time) {
                    document.getElementById('currentPrice').textContent = '$0.00';
                    return;
                }

                const data = param.seriesData.get(candleSeries);
                if (data) {
                    let displayText = '';
                    if (data.open !== undefined) {
                        // OHLC data available
                        displayText = `O: $${data.open.toFixed(2)} H: $${data.high.toFixed(2)} L: $${data.low.toFixed(2)} C: $${data.close.toFixed(2)}`;
                    } else if (data.value !== undefined) {
                        // Line series data
                        displayText = `$${data.value.toFixed(2)}`;
                    }
                    document.getElementById('currentPrice').textContent = displayText;
                }
            });

            console.log(' TradingView chart initialized');
            
            // DO NOT LOAD FAKE DATA - wait for real Kraken data
            // loadPlaceholderData();  // REMOVED - was causing fake data issues
        }
        
        // REMOVED - This was generating FAKE random data!
        function loadPlaceholderData() {
            console.warn(' loadPlaceholderData DISABLED - only real Kraken data allowed');
            // DO NOT generate fake data - chart should start empty
            // Real data comes from WebSocket connection to Kraken
            return;
        }
        
        // ============================================
        // CHART UPDATE FUNCTIONS
        // ============================================
        
        function updateChart(data) {
            if (!candleSeries) return;

            const price = parseFloat(data.price || data.close);
            if (!price || isNaN(price) || price <= 0) return;
            
            // Update price display
            lastPrice = price;
            document.getElementById('currentPrice').textContent = '$' + price.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            let timestamp = data.candle?.timestamp || data.timestamp || Date.now();
            if (timestamp > 9999999999) timestamp = Math.floor(timestamp / 1000);

            // CHANGE 2026-01-22: Normalize timestamp to start of minute for 1m candles
            // This prevents duplicate candles (e.g., 02:12, 02:12, 02:12) from appearing
            // All updates within the same minute will update the SAME candle
            const timeframeSeconds = 60;  // 1 minute candles
            timestamp = Math.floor(timestamp / timeframeSeconds) * timeframeSeconds;

            // CHANGE 2026-01-29: Convert UTC to local time for chart display
            timestamp = timeToLocal(timestamp);

            // Update candle
            if (data.candle) {
                const candle = {
                    time: timestamp,
                    open: parseFloat(data.candle.open || price),
                    high: parseFloat(data.candle.high || price),
                    low: parseFloat(data.candle.low || price),
                    close: price,
                };

                // CHANGE 2026-01-22: Use try/catch to handle "oldest data" errors gracefully
                try {
                    if (currentChartType === 'candlestick') {
                        candleSeries.update(candle);
                    } else {
                        lineSeries.update({ time: timestamp, value: price });
                    }
                } catch (e) {
                    // Ignore "Cannot update oldest data" errors - just skip this update
                    if (!e.message?.includes('oldest data')) {
                        console.warn('Chart update error:', e.message);
                    }
                }

                // Volume
                if (data.candle.volume) {
                    try {
                        volumeSeries.update({
                            time: timestamp,
                            value: parseFloat(data.candle.volume),
                            color: candle.close >= candle.open ? 'rgba(0, 255, 136, 0.3)' : 'rgba(255, 51, 102, 0.3)',
                        });
                    } catch (e) {
                        // Ignore volume update errors
                    }
                }
            }

            // Update indicator overlays
            if (data.indicators) {
                updateIndicatorOverlaysOnChart(timestamp, data.indicators);
                updateIndicatorValues(data.indicators);
            }

            // CHANGE 2026-01-22: Auto-scroll to keep latest candle visible
            if (autoScrollEnabled && tvChart) {
                tvChart.timeScale().scrollToRealTime();
            }
        }
        
        function updateIndicatorOverlaysOnChart(time, indicators) {
            // DEBUG: Log what we receive (remove after fixing)
            if (!window._indicatorDebugLogged) {
                console.log(' [INDICATOR DEBUG] Received indicators:', JSON.stringify(indicators, null, 2));
                console.log(' [INDICATOR DEBUG] Active overlays:', activeOverlays);
                window._indicatorDebugLogged = true;
                // Reset after 30 seconds to log again
                setTimeout(() => { window._indicatorDebugLogged = false; }, 30000);
            }

            // EMAs - check both formats: ema[20] and ema.20
            if (indicators.ema) {
                const ema20 = indicators.ema[20] || indicators.ema['20'];
                const ema50 = indicators.ema[50] || indicators.ema['50'];
                const ema200 = indicators.ema[200] || indicators.ema['200'];

                if (ema20) ema20Series.update({ time, value: ema20 });
                if (ema50) ema50Series.update({ time, value: ema50 });
                if (ema200) ema200Series.update({ time, value: ema200 });
            }
            
            // Bollinger Bands
            if (indicators.bb) {
                if (indicators.bb.upper) bbUpperSeries.update({ time, value: indicators.bb.upper });
                if (indicators.bb.mid) bbMiddleSeries.update({ time, value: indicators.bb.mid });
                if (indicators.bb.lower) bbLowerSeries.update({ time, value: indicators.bb.lower });
            }
            
            // VWAP
            if (indicators.vwap) {
                vwapSeries.update({ time, value: indicators.vwap });
            }
            
            // SuperTrend
            if (indicators.superTrend && indicators.superTrend.value) {
                superTrendSeries.update({ time, value: indicators.superTrend.value });
                superTrendSeries.applyOptions({
                    color: indicators.superTrend.trend === 1 ? COLORS.superTrendUp : COLORS.superTrendDown
                });
            }
        }
        
        // CHANGE 2026-01-30: Calculate indicators from historical candle data
        function calculateEMA(closes, period) {
            const k = 2 / (period + 1);
            const ema = [];
            let prev = closes[0];
            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) {
                    // Not enough data yet, use SMA
                    const slice = closes.slice(0, i + 1);
                    prev = slice.reduce((a, b) => a + b, 0) / slice.length;
                } else {
                    prev = closes[i] * k + prev * (1 - k);
                }
                ema.push(prev);
            }
            return ema;
        }

        function calculateBollingerBands(closes, period = 20, stdDev = 2) {
            const bands = { upper: [], middle: [], lower: [] };
            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) {
                    bands.upper.push(null);
                    bands.middle.push(null);
                    bands.lower.push(null);
                } else {
                    const slice = closes.slice(i - period + 1, i + 1);
                    const sma = slice.reduce((a, b) => a + b, 0) / period;
                    const variance = slice.reduce((sum, val) => sum + Math.pow(val - sma, 2), 0) / period;
                    const std = Math.sqrt(variance);
                    bands.middle.push(sma);
                    bands.upper.push(sma + stdDev * std);
                    bands.lower.push(sma - stdDev * std);
                }
            }
            return bands;
        }

        function calculateVWAP(candles) {
            const vwap = [];
            let cumVolume = 0;
            let cumTP = 0;
            for (let i = 0; i < candles.length; i++) {
                const tp = (candles[i].high + candles[i].low + candles[i].close) / 3;
                const vol = candles[i].volume || 1;
                cumVolume += vol;
                cumTP += tp * vol;
                vwap.push(cumVolume > 0 ? cumTP / cumVolume : tp);
            }
            return vwap;
        }

        function loadHistoricalCandles(candles) {
            if (!candleSeries || !candles || !candles.length) return;

            const data = candles.map(c => {
                let t = c.t || c.timestamp;
                if (t > 9999999999) t = Math.floor(t / 1000);
                // CHANGE 2026-01-29: Convert UTC to local time for chart display
                t = timeToLocal(t);
                return {
                    time: t,
                    open: parseFloat(c.o || c.open),
                    high: parseFloat(c.h || c.high),
                    low: parseFloat(c.l || c.low),
                    close: parseFloat(c.c || c.close),
                    volume: parseFloat(c.v || c.volume || 0),
                };
            });

            candleSeries.setData(data);
            lineSeries.setData(data.map(d => ({ time: d.time, value: d.close })));
            console.log(` Loaded ${data.length} historical candles`);

            // CHANGE 2026-01-30: Calculate and display indicators from historical data
            if (data.length > 20) {
                const closes = data.map(d => d.close);
                const times = data.map(d => d.time);

                // EMAs
                const ema20 = calculateEMA(closes, 20);
                const ema50 = calculateEMA(closes, 50);
                const ema200 = calculateEMA(closes, 200);

                ema20Series.setData(ema20.map((v, i) => ({ time: times[i], value: v })));
                ema50Series.setData(ema50.map((v, i) => ({ time: times[i], value: v })));
                ema200Series.setData(ema200.map((v, i) => ({ time: times[i], value: v })));

                // Bollinger Bands
                const bb = calculateBollingerBands(closes, 20, 2);
                bbUpperSeries.setData(bb.upper.map((v, i) => v ? { time: times[i], value: v } : null).filter(x => x));
                bbMiddleSeries.setData(bb.middle.map((v, i) => v ? { time: times[i], value: v } : null).filter(x => x));
                bbLowerSeries.setData(bb.lower.map((v, i) => v ? { time: times[i], value: v } : null).filter(x => x));

                // VWAP
                const vwap = calculateVWAP(data);
                vwapSeries.setData(vwap.map((v, i) => ({ time: times[i], value: v })));

                console.log(` Calculated indicators for ${data.length} candles`);
            }

            // Volume bars
            if (volumeSeries && data.some(d => d.volume > 0)) {
                volumeSeries.setData(data.map(d => ({
                    time: d.time,
                    value: d.volume,
                    color: d.close >= d.open ? 'rgba(0, 255, 136, 0.3)' : 'rgba(255, 51, 102, 0.3)',
                })));
            }

            // CHANGE 2026-01-21: Auto-fit chart to show reasonable detail
            // Show last 50 candles by default for good zoom level
            if (data.length > 0 && tvChart) {
                const barsToShow = Math.min(50, data.length);
                tvChart.timeScale().setVisibleLogicalRange({
                    from: data.length - barsToShow,
                    to: data.length
                });
            }
        }
        
        // ============================================
        // WEBSOCKET
        // ============================================
        
        let reconnectTimer = null;
        let backoffMs = 250;
        let heartbeatInterval = null;
        let missedPongs = 0;

        // Heartbeat functions to keep WebSocket alive
        function startHeartbeat() {
            stopHeartbeat(); // Clear any existing heartbeat
            missedPongs = 0;

            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    missedPongs++;

                    // If we've missed 3 pongs, reconnect
                    if (missedPongs >= 3) {
                        console.warn('[WS] Missed 3 heartbeats, reconnecting...');
                        ws.close();
                        return;
                    }

                    // Send ping
                    ws.send(JSON.stringify({
                        type: 'ping',
                        timestamp: Date.now()
                    }));
                    console.log('[WS] Ping sent');
                }
            }, 30000); // Ping every 30 seconds
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            missedPongs = 0;
        }

        function scheduleReconnect(url) {
            if (reconnectTimer) return;
            const wait = Math.min(backoffMs, 5000);
            backoffMs = Math.min(backoffMs * 2, 5000);
            console.log(`[WS] Reconnecting in ${wait}ms`);
            reconnectTimer = setTimeout(() => {
                reconnectTimer = null;
                connectWebSocket();
            }, wait);
        }

        function connectWebSocket() {
            const url = 'wss://ogzprime.com/ws';

            if (window.__ws && (window.__ws.readyState === WebSocket.OPEN || window.__ws.readyState === WebSocket.CONNECTING)) {
                return window.__ws;
            }

            console.log('[WS] Connecting to', url);
            ws = new WebSocket(url);
            window.__ws = ws;

            ws.addEventListener("open", () => {
                console.log('[WS] Connected');
                document.getElementById('connectionStatus').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                backoffMs = 250;

                // Auth
                ws.send(JSON.stringify({
                    type: 'auth',
                    token: '39ccfbc54660e6075f07730285badebbc40d805748c8eeb7d7f2e32d15ae1c62'
                }));

                // Start heartbeat to keep connection alive
                startHeartbeat();
            });

            ws.addEventListener("error", (e) => {
                console.error('[WS] Error:', e);
            });

            ws.addEventListener("close", (e) => {
                console.log('[WS] Closed');
                document.getElementById('connectionStatus').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
                stopHeartbeat();
                scheduleReconnect(url);
            });

            ws.addEventListener("message", (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (err) {
                    console.error('[WS] Parse error:', err);
                }
            });

            return ws;
        }
        
        function handleWebSocketMessage(data) {
            // Auth success
            if (data.type === 'auth_success') {
                console.log('[WS] Auth successful');
                ws.send(JSON.stringify({
                    type: 'identify',
                    source: 'dashboard',
                    tier: currentTier,
                    version: '2.0.0'
                }));
                return;
            }

            if (data.type === 'error') {
                console.error('[WS] Error:', data.message);
                return;
            }

            // Handle pong response to reset missed count
            if (data.type === 'pong') {
                missedPongs = 0;
                console.log('[WS] Pong received');
                return;
            }

            // Price updates
            if (data.type === 'price' && data.data) {
                updateChart(data.data);

                // CHANGE 2026-01-22: Update DATA status light
                statusTimestamps.data = Date.now();
                updateStatusLight('dataLight', 'green');

                // CHANGE 2026-01-23: Update BOT status light too (price comes from bot)
                statusTimestamps.bot = Date.now();
                updateStatusLight('botLight', 'green');

                // CHANGE 2026-01-23: Update performance stats from price message
                if (data.data.totalPnL !== undefined) {
                    const pnl = data.data.totalPnL;
                    const el = document.getElementById('totalPnl');
                    if (el) {
                        el.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                        el.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                }
                if (data.data.winRate !== undefined) {
                    const el = document.getElementById('winRate');
                    if (el) {
                        el.textContent = `${data.data.winRate.toFixed(1)}%`;
                    }
                }

                // Historical candles on FIRST load only
                if (!window.__historicalLoaded && data.data.candles && data.data.candles.length > 0) {
                    loadHistoricalCandles(data.data.candles);
                    window.__historicalLoaded = true;
                }
            }

            // CHANGE 2026-01-29: Handle historical candles for timeframe changes
            else if (data.type === 'historical_candles') {
                console.log(` Received ${data.candles?.length || 0} candles for ${data.timeframe}`);
                if (data.candles && data.candles.length > 0) {
                    // Clear existing chart data and load new timeframe candles
                    if (candleSeries) candleSeries.setData([]);
                    if (volumeSeries) volumeSeries.setData([]);
                    loadHistoricalCandles(data.candles);
                    window.__historicalLoaded = true;

                    // Update chart title with timeframe
                    const title = document.getElementById('chartTitle');
                    if (title) {
                        const tierText = currentTier === 'ml' ? 'ML VERSION' : 'CORE VERSION';
                        title.textContent = `${tierText} - ${data.timeframe?.toUpperCase() || '1M'}`;
                    }
                }
            }

            // Trade messages
            else if (data.type === 'trade') {
                const botTier = data.botTier || data.tier || 'ml';
                const mappedTier = (botTier === 'quantum' || botTier === 'elite') ? 'ml' :
                                   (botTier === 'starter' || botTier === 'pro') ? 'core' : botTier;

                // CHANGE 2026-01-30: Prioritize action (BUY/SELL) over direction (long/short) for spot trading
                const tradeData = {
                    type: data.action || data.direction || 'trade',
                    price: data.price || lastPrice,
                    pnl: data.pnl || 0,
                    timestamp: data.timestamp || Date.now(),
                    duration: data.duration || null,
                    side: data.side || data.action,
                    direction: data.direction
                };

                addTradeToLog(tradeData);
                plotTradeSignal(tradeData);  // Add trade marker to chart

                updateBotStatus(mappedTier, data);
                updateStats(data);

                // CHANGE 2026-01-22: Update BOT status light on trade
                statusTimestamps.bot = Date.now();
                updateStatusLight('botLight', 'green');
            }

            // Bot status
            else if (data.type === 'bot_status') {
                const tier = data.tier || data.botTier || 'ml';
                const mappedTier = (tier === 'quantum' || tier === 'elite') ? 'ml' :
                                   (tier === 'starter' || tier === 'pro') ? 'core' : tier;
                botStates[mappedTier] = { ...botStates[mappedTier], ...data };
                updateBotStatusIndicators();

                // CHANGE 2026-01-22: Update BOT status light
                statusTimestamps.bot = Date.now();
                updateStatusLight('botLight', 'green');
            }

            // Bot thinking - Chain of Thought
            else if (data.type === 'bot_thinking') {
                const thought = {
                    analysis: data.message || data.data?.reasoning || 'Processing...',
                    pattern: data.data?.pattern || 'Scanning...',
                    confidence: data.confidence || data.data?.finalConfidence || '0',
                    decision: data.data?.recommendation || 'Evaluating...',
                    rsi: data.data?.rsi,
                    trend: data.data?.trend,
                    riskScore: data.data?.riskScore
                };
                updateChainOfThought(thought);

                // CHANGE 2026-01-22: Update TRAI status light (chain of thought = TRAI working)
                statusTimestamps.trai = Date.now();
                updateStatusLight('traiLight', 'green');
            }

            // State updates
            else if (data.type === 'state_update') {
                if (data.state) {
                    if (data.state.totalPnL !== undefined) {
                        const pnl = data.state.totalPnL;
                        const el = document.getElementById('totalPnl');
                        el.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                        el.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                    if (data.state.tradeCount !== undefined) {
                        document.getElementById('tradesExecuted').textContent = data.state.tradeCount;
                    }
                    // Update pause/resume UI based on state
                    if (data.state.pauseReason !== undefined || data.state.isTrading !== undefined) {
                        const isPaused = !data.state.isTrading || data.state.pauseReason;
                        updatePauseResumeUI(isPaused, data.state.pauseReason);
                    }
                }
            }

            // Pause/Resume confirmations
            else if (data.type === 'pause_confirmed') {
                console.log(' Trading paused:', data.reason);
                updatePauseResumeUI(true, data.reason);
                alert('Trading PAUSED: ' + data.reason);
            }
            else if (data.type === 'resume_confirmed') {
                console.log(' Trading resumed');
                updatePauseResumeUI(false);
                alert('Trading RESUMED');
            }

            // Pattern analysis - CHANGE 2026-01-29: Enhanced with descriptions
            // CHANGE 2026-01-30: Added SVG pattern visualizations
            else if (data.type === 'pattern_analysis') {
                const pattern = data.pattern || {};
                const patternInfo = getPatternInfo(pattern.name);

                // Update pattern name with emoji
                document.getElementById('currentPatternName').textContent =
                    `${patternInfo.emoji} ${patternInfo.name}`;

                // CHANGE 2026-01-30: Render pattern SVG visualization
                const patternVisual = document.getElementById('patternVisual');
                if (patternVisual && pattern.name) {
                    const svg = getPatternSVG(pattern.name);
                    patternVisual.innerHTML = svg;
                }

                // Update description with confidence and educational content
                document.getElementById('patternDescription').innerHTML = `
                    <p class="pattern-info"><strong>Confidence:</strong> ${pattern.confidence || 0}%</p>
                    <p class="pattern-info" style="color: #ddd; margin-top: 8px;">${patternInfo.description}</p>
                `;

                // Update pattern memory stats if available
                if (data.patternMemory) {
                    const mem = data.patternMemory;
                    document.getElementById('patternDescription').innerHTML += `
                        <p class="pattern-info" style="margin-top: 10px; color: #888; font-size: 11px;">
                             ${mem.status} | ${mem.count} patterns learned | ${mem.uniquePatterns} unique
                        </p>
                    `;
                }

                // Draw pattern visualization if we have pattern data
                if (pattern.allPatterns && pattern.allPatterns.length > 0) {
                    drawPatternVisualization(pattern.allPatterns);
                }
            }

            // CRITICAL ADDITION - Trade signal plotting handler
            else if (data.type === 'trade_opened' && data.trade) {
                plotTradeSignal(data.trade);
            }

            // Neural votes
            else if (data.type === 'neural_vote') {
                updateNeuralVotes(data);
            }

            // Indicators
            else if (data.type === 'indicators') {
                updateIndicatorValues(data);
            }

            // Performance
            else if (data.type === 'performance_update') {
                if (data.data) {
                    if (data.data.winRate !== undefined) {
                        document.getElementById('winRate').textContent = `${data.data.winRate.toFixed(1)}%`;
                    }
                    if (data.data.totalPnl !== undefined) {
                        const pnl = data.data.totalPnl;
                        const el = document.getElementById('totalPnl');
                        el.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                        el.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                }
            }

            // Trade levels
            else if (data.type === 'trade_levels') {
                console.log('Trade levels:', data.fibLevels, data.srLevels);
            }

            // Edge Analytics Data Handlers

            // Liquidation data
            else if (data.type === 'liquidation_data') {
                if (data.levels) {
                    updateLiquidationLevels(data.levels);
                }
            }

            // Order flow / CVD data
            else if (data.type === 'order_flow' || data.type === 'cvd_update') {
                if (data.cvd !== undefined) {
                    updateCVD(data.cvd, data.buyVolume, data.sellVolume);
                }
            }

            // Funding rates
            else if (data.type === 'funding_rate') {
                if (data.current !== undefined) {
                    updateFundingRates(data.current, data.predicted);
                }
            }

            // Whale trades
            else if (data.type === 'whale_trade' || data.type === 'large_trade') {
                if (data.size && data.price) {
                    processWhaleAlert(data);
                }
            }

            // Market internals
            else if (data.type === 'market_internals') {
                if (data.buySellRatio !== undefined) {
                    updateMarketInternals(data);
                }
            }

            // On-chain metrics
            else if (data.type === 'onchain_metrics') {
                if (data.nvt !== undefined || data.mvrv !== undefined) {
                    updateOnChainMetrics(data);
                }
            }

            // Smart money flow
            else if (data.type === 'smart_money') {
                if (data.flow || data.activity) {
                    updateSmartMoneyFlow(data);
                }
            }

            // Fear & Greed Index
            else if (data.type === 'fear_greed') {
                if (data.value !== undefined) {
                    updateFearGreedIndex(data.value);
                }
            }

            // Divergence alerts
            else if (data.type === 'divergence') {
                if (data.divergences) {
                    updateDivergences(data.divergences);
                }
            }
        }
        
        // ============================================
        // UI UPDATE FUNCTIONS (Original functionality)
        // ============================================
        
        function switchTier(tier) {
            currentTier = tier;
            const chartSection = document.getElementById('unifiedChart');

            chartSection.classList.remove('tier-core', 'tier-ml');
            chartSection.classList.add(`tier-${tier}`);

            document.getElementById('chartTitle').textContent = tierConfigs[tier].title;
            updateBotStatusIndicators();

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'tier_change', tier }));
            }

            updateTierFeatures(tier);
        }
        
        function updateBotStatusIndicators() {
            ['core', 'ml'].forEach(tier => {
                const indicator = document.getElementById(`${tier}Status`);
                if (indicator) {
                    indicator.classList.toggle('active', botStates[tier].connected);
                }
            });
        }
        
        function updateTierFeatures(tier) {
            const config = tierConfigs[tier];

            const neuralEnsemble = document.querySelector('.neural-ensemble');
            if (neuralEnsemble) {
                neuralEnsemble.style.display = config.features.neural ? 'block' : 'none';
            }

            const chainOfThought = document.querySelector('.chain-of-thought');
            if (chainOfThought) {
                chainOfThought.style.display = config.features.chainOfThought ? 'block' : 'none';
            }

            const coreIndicators = document.querySelector('.core-indicators');
            const mlIndicators = document.querySelector('.ml-indicators');
            if (coreIndicators && mlIndicators) {
                coreIndicators.style.display = tier === 'core' ? 'block' : 'none';
                mlIndicators.style.display = tier === 'ml' ? 'block' : 'none';
            }
        }
        
        function updateIndicatorValues(data) {
            const indicators = data.indicators || data;
            
            if (indicators.rsi !== undefined && indicators.rsi !== null) {
                ['rsiCore', 'rsiML'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = indicators.rsi.toFixed(1);
                });
            }
            
            if (indicators.macd) {
                const macd = indicators.macd.macd || indicators.macd;
                ['macdCore', 'macdML'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = (typeof macd === 'number' ? macd : 0).toFixed(2);
                });
            }
            
            if (indicators.pattern) {
                ['patternCore', 'patternML'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = indicators.pattern;
                });
                document.getElementById('currentPatternName').textContent = `Pattern: ${indicators.pattern}`;
            }
            
            // ML-specific
            if (currentTier === 'ml') {
                if (indicators.atr !== undefined && indicators.atr !== null) {
                    const el = document.getElementById('atrML');
                    if (el) el.textContent = indicators.atr.toFixed(2);
                }
                if (indicators.confidence !== undefined && indicators.confidence !== null) {
                    const el = document.getElementById('confidenceML');
                    if (el) el.textContent = `${indicators.confidence}%`;
                }
            }
        }
        
        function updateNeuralVotes(data) {
            const votes = data.votes || {};
            Object.keys(votes).forEach(brain => {
                const voteEl = document.getElementById(`${brain}Vote`);
                const confEl = document.getElementById(`${brain}Conf`);
                if (voteEl) {
                    const vote = votes[brain].decision || votes[brain];
                    voteEl.textContent = vote;
                    voteEl.className = `brain-vote vote-${vote.toLowerCase()}`;
                }
                if (confEl && votes[brain].confidence !== undefined) {
                    confEl.textContent = `${votes[brain].confidence}%`;
                }
            });
        }
        
        function updateBotStatus(tier, data) {
            if (tier && botStates[tier]) {
                botStates[tier].connected = true;
                if (data.pnl !== undefined) botStates[tier].pnl += data.pnl;
                if (data.confidence !== undefined) botStates[tier].confidence = data.confidence;
                botStates[tier].trades++;
                updateBotStatusIndicators();
            }
        }
        
        function updateStats(data) {
            let totalPnl = 0;
            let avgConfidence = 0;
            let activeCount = 0;

            Object.keys(botStates).forEach(tier => {
                if (botStates[tier].connected) {
                    totalPnl += botStates[tier].pnl || 0;
                    avgConfidence += botStates[tier].confidence || 0;
                    activeCount++;
                }
            });

            if (activeCount > 0) avgConfidence /= activeCount;

            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}`;
            pnlEl.className = `stat-value ${totalPnl >= 0 ? 'positive' : 'negative'}`;

            if (data.winRate !== undefined) {
                document.getElementById('winRate').textContent = `${data.winRate.toFixed(1)}%`;
            }

            document.getElementById('confidence').textContent = `${avgConfidence.toFixed(1)}%`;
            document.getElementById('tradesExecuted').textContent = tradesExecuted;
        }

        // CHANGE 2026-01-29: Improved trade log display for proof
        function addTradeToLog(trade) {
            const tradeLog = document.getElementById('tradeLog');
            const entry = document.createElement('div');
            entry.className = 'trade-log-entry';

            const isBuy = trade.type?.toLowerCase() === 'buy' || trade.direction === 'long';
            const color = tradeColors[trade.type?.toLowerCase()] || (isBuy ? '#00ff41' : '#ff4444');
            const price = trade.price ? `$${trade.price.toLocaleString()}` : '';

            let valueDisplay;
            if (isBuy) {
                // BUY: Show entry price
                valueDisplay = `@ ${price}`;
            } else {
                // SELL: Show actual P&L with color
                const pnl = trade.pnl || 0;
                const isProfit = pnl >= 0;
                const pnlClass = isProfit ? 'positive' : 'negative';
                valueDisplay = `<span class="${pnlClass}">${isProfit ? '+' : '-'}$${Math.abs(pnl).toFixed(2)}</span>`;
            }

            entry.innerHTML = `
                <span class="trade-type" style="color: ${color}">${(trade.type || 'TRADE').toUpperCase()}</span>
                <span class="trade-value">${valueDisplay}</span>
                <span class="trade-time">${new Date(trade.timestamp).toLocaleTimeString()}${trade.duration ? `  ${trade.duration}` : ''}</span>
            `;

            tradeLog.insertBefore(entry, tradeLog.firstChild);
            while (tradeLog.children.length > 20) tradeLog.removeChild(tradeLog.lastChild);

            tradesExecuted++;
            document.getElementById('tradesExecuted').textContent = tradesExecuted;
        }

        // CHANGE 2026-01-30: Enhanced Chain of Thought display
        function updateChainOfThought(thought) {
            const display = document.getElementById('thoughtDisplay');
            if (display && thought) {
                const decision = (thought.decision || 'HOLD').toUpperCase();
                const decisionClass = decision === 'BUY' ? 'buy' : decision === 'SELL' ? 'sell' : 'hold';

                display.innerHTML = `
                    <p class="thought-step"><strong> Analysis:</strong> ${thought.analysis}</p>
                    <p class="thought-step"><strong> Trend:</strong> ${thought.trend || 'N/A'} | <strong>RSI:</strong> ${thought.rsi ? parseFloat(thought.rsi).toFixed(1) : 'N/A'}</p>
                    <p class="thought-step"><strong> Confidence:</strong> ${thought.confidence}%</p>
                    <p class="thought-step"><strong> Risk Score:</strong> ${thought.riskScore || 'N/A'}</p>
                    <div style="text-align: center; margin-top: 12px;">
                        <span class="decision-badge ${decisionClass}">${decision}</span>
                    </div>
                `;
            }
        }

        // Simple pattern visualization on canvas
        function drawPatternVisualization(patterns) {
            const canvas = document.getElementById('patternCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw confidence bars for each pattern
            const barHeight = 15;
            const maxWidth = canvas.width - 20;

            patterns.slice(0, 5).forEach((p, i) => {
                const y = 10 + (i * (barHeight + 5));
                const width = (p.confidence / 100) * maxWidth;

                // Background
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.fillRect(10, y, maxWidth, barHeight);

                // Confidence bar
                ctx.fillStyle = p.confidence > 70 ? '#00ff41' : p.confidence > 40 ? '#ffd700' : '#ff4444';
                ctx.fillRect(10, y, width, barHeight);

                // Label
                ctx.fillStyle = '#fff';
                ctx.font = '10px JetBrains Mono';
                ctx.fillText(`${p.name}: ${p.confidence}%`, 15, y + 11);
            });
        }

        // CRITICAL ADDITION FROM OUR VERSION - Trade signal plotting
        function plotTradeSignal(trade) {
            if (!candleSeries) {
                console.warn('Chart not ready for trade plotting');
                return;
            }

            // Plot marker on the chart
            const isLong = trade.type === 'BUY' || trade.side === 'buy' || trade.direction === 'long';
            // CHANGE 2026-01-29: Convert trade timestamp to local time for chart
            let tradeTime = trade.timestamp ? Math.floor(trade.timestamp / 1000) : Math.floor(Date.now() / 1000);
            tradeTime = timeToLocal(tradeTime);
            const marker = {
                time: tradeTime,
                position: isLong ? 'belowBar' : 'aboveBar',
                color: isLong ? '#00ff88' : '#ff3366',
                shape: isLong ? 'arrowUp' : 'arrowDown',
                text: `${isLong ? 'BUY' : 'SELL'} @ ${trade.price || lastPrice}`
            };

            // Get existing markers and add new one
            const existingMarkers = candleSeries.markers() || [];
            existingMarkers.push(marker);
            candleSeries.setMarkers(existingMarkers);

            // Also add to trade log
            const tradeData = {
                type: isLong ? 'buy' : 'sell',
                pnl: trade.pnl || 0,
                timestamp: trade.timestamp || Date.now()
            };
            updateTradeHistory(tradeData);

            console.log(` Trade signal plotted: ${marker.text}`);
        }
        
        function executeTrade(action) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: `manual_${action}`,
                    tier: currentTier,
                    timestamp: Date.now()
                }));
            }
        }

        // PAUSE/RESUME TRADING CONTROLS
        function pauseTrading() {
            const reason = prompt('Pause reason (optional):', 'Manual pause from dashboard');
            if (reason === null) return; // User cancelled

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'command',
                    command: 'pause_trading',
                    reason: reason || 'Manual pause from dashboard',
                    timestamp: Date.now()
                }));
                console.log(' Pause command sent');
            }
        }

        function resumeTrading() {
            if (!confirm('Resume trading? Make sure conditions are safe.')) return;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'command',
                    command: 'resume_trading',
                    timestamp: Date.now()
                }));
                console.log(' Resume command sent');
            }
        }

        // Update pause/resume button visibility based on state
        function updatePauseResumeUI(isPaused, reason) {
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const pauseStatus = document.getElementById('pauseStatus');
            const pauseReason = document.getElementById('pauseReason');

            if (isPaused) {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'block';
                pauseStatus.style.display = 'block';
                pauseReason.textContent = ' PAUSED: ' + (reason || 'Unknown reason');
            } else {
                pauseBtn.style.display = 'block';
                resumeBtn.style.display = 'none';
                pauseStatus.style.display = 'none';
            }
        }

        function changeChartType(type) {
            currentChartType = type;
            candleSeries.applyOptions({ visible: type === 'candlestick' });
            lineSeries.applyOptions({ visible: type === 'line' });

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'chart_type_change', chartType: type }));
            }
        }

        function changeAsset(asset) {
            console.log('Asset changed to:', asset);
            candleSeries.setData([]);
            lineSeries.setData([]);
            window.__historicalLoaded = false; // Reset to reload history

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'asset_change', asset }));
            }
        }

        // Handle timeframe changes
        let currentTimeframe = '1m';
        function changeTimeframe(timeframe) {
            console.log('Timeframe changed to:', timeframe);
            currentTimeframe = timeframe;

            // Clear current chart data
            if (candleSeries) candleSeries.setData([]);
            if (lineSeries) lineSeries.setData([]);
            window.__historicalLoaded = false; // Reset to reload history

            // Request new data with the selected timeframe
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'timeframe_change',
                    timeframe: timeframe,
                    asset: document.getElementById('assetSelector').value
                }));

                // Request historical data for the new timeframe
                ws.send(JSON.stringify({
                    type: 'request_historical',
                    timeframe: timeframe,
                    asset: document.getElementById('assetSelector').value,
                    limit: 500
                }));
            }

            // Update chart title to show timeframe
            const title = document.getElementById('chartTitle');
            if (title) {
                const tierText = currentTier === 'ml' ? 'ML VERSION' : 'CORE VERSION';
                title.textContent = `${tierText} - ${timeframe.toUpperCase()}`;
            }
        }

        function updateIndicatorOverlays() {
            const checkboxes = document.querySelectorAll('#indicatorCheckboxes input[type="checkbox"]:checked');
            activeOverlays = Array.from(checkboxes).map(cb => cb.value);
            console.log('Selected indicators:', activeOverlays);

            // Toggle visibility
            ema20Series.applyOptions({ visible: activeOverlays.includes('ema') });
            ema50Series.applyOptions({ visible: activeOverlays.includes('ema') });
            ema200Series.applyOptions({ visible: activeOverlays.includes('ema') });
            bbUpperSeries.applyOptions({ visible: activeOverlays.includes('bollinger') });
            bbMiddleSeries.applyOptions({ visible: activeOverlays.includes('bollinger') });
            bbLowerSeries.applyOptions({ visible: activeOverlays.includes('bollinger') });
            vwapSeries.applyOptions({ visible: activeOverlays.includes('vwap') });

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'indicator_selection', indicators: activeOverlays }));
            }
        }

        function showUpgradeOptions() {
            alert('Contact sales@ogzprime.com for ML Version access!');
        }

        // ============================================
        // STATUS LIGHTS - CHANGE 2026-01-22
        // ============================================

        // Track last update times for each system
        const statusTimestamps = {
            data: 0,
            bot: 0,
            trai: 0
        };
        // CHANGE 2026-01-23: Expose for TRAI widget to update
        window.statusTimestamps = statusTimestamps;

        // Status light states: 'green', 'yellow', 'red', or '' (off)
        function updateStatusLight(lightId, status) {
            const light = document.getElementById(lightId);
            if (!light) return;

            // Remove all status classes
            light.classList.remove('green', 'yellow', 'red');

            // Add new status
            if (status) {
                light.classList.add(status);
            }
        }

        // Check for stale data (no updates in X seconds)
        function checkStatusStaleness() {
            const now = Date.now();
            const DATA_TIMEOUT = 10000;   // 10 seconds
            const BOT_TIMEOUT = 30000;    // 30 seconds
            const TRAI_TIMEOUT = 60000;   // 60 seconds

            // DATA light - goes yellow if no price in 10s, red if 30s
            if (statusTimestamps.data > 0) {
                const dataAge = now - statusTimestamps.data;
                if (dataAge > 30000) {
                    updateStatusLight('dataLight', 'red');
                } else if (dataAge > DATA_TIMEOUT) {
                    updateStatusLight('dataLight', 'yellow');
                }
            }

            // BOT light - goes yellow if no activity in 30s
            if (statusTimestamps.bot > 0) {
                const botAge = now - statusTimestamps.bot;
                if (botAge > 120000) {
                    updateStatusLight('botLight', 'red');
                } else if (botAge > BOT_TIMEOUT) {
                    updateStatusLight('botLight', 'yellow');
                }
            }

            // TRAI light - goes yellow if no response in 60s
            if (statusTimestamps.trai > 0) {
                const traiAge = now - statusTimestamps.trai;
                if (traiAge > 180000) {
                    updateStatusLight('traiLight', 'red');
                } else if (traiAge > TRAI_TIMEOUT) {
                    updateStatusLight('traiLight', 'yellow');
                }
            }
        }

        // Start staleness checker
        setInterval(checkStatusStaleness, 5000);

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = () => {
            console.log(' OGZPrime Dashboard Initializing...');

            // CHANGE 2026-01-22: Set default indicator checkboxes to match activeOverlays
            activeOverlays.forEach(overlay => {
                const checkbox = document.getElementById(`chk-${overlay}`);
                if (checkbox) checkbox.checked = true;
            });

            // CHANGE 2026-01-30: Load saved theme preferences
            loadThemePreferences();

            initChart();
            connectWebSocket();
            switchTier('ml');

            setTimeout(() => {
                ['core', 'ml'].forEach(tier => {
                    botStates[tier].connected = true;
                });
                updateBotStatusIndicators();
            }, 2000);

            console.log(' OGZPrime Dashboard Ready');
        };

        // Drawing Tools Functions
        let currentDrawingTool = null;
        let drawings = [];

        function activateDrawingTool(tool) {
            currentDrawingTool = tool;

            // Update active state
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Add chart interaction based on tool
            if (chart) {
                switch(tool) {
                    case 'trendline':
                        console.log('Trendline tool activated');
                        // Implementation would use chart library's drawing API
                        break;
                    case 'horizontal':
                        console.log('Horizontal line tool activated');
                        break;
                    case 'fibonacci':
                        console.log('Fibonacci tool activated');
                        break;
                    // Add other tools
                }
            }
        }

        function clearDrawings() {
            drawings = [];
            // Clear from chart
            console.log('Drawings cleared');
        }

        // Panel Toggle Functions - auto-resize chart
        function toggleEdgePanel() {
            const panel = document.getElementById('edgePanel');
            const mainContainer = document.querySelector('.main-container');
            const toggle = panel.querySelector('.edge-toggle');

            panel.classList.toggle('collapsed');
            mainContainer.classList.toggle('right-collapsed');
            toggle.textContent = panel.classList.contains('collapsed') ? '+' : '';

            // Resize chart after transition
            setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
        }

        function toggleTradeManager() {
            const manager = document.getElementById('tradeManager');
            const mainContainer = document.querySelector('.main-container');

            manager.classList.toggle('collapsed');
            mainContainer.classList.toggle('left-collapsed');

            // Resize chart after transition
            setTimeout(() => window.dispatchEvent(new Event('resize')), 350);
        }

        // CHANGE 2026-01-30: Theme customization functions
        const THEMES = {
            default: {
                '--bg-primary': '#000000',
                '--bg-secondary': '#0a0a0a',
                '--text-primary': '#ffffff',
                '--profit-color': '#00ff88',
                '--loss-color': '#ff3366'
            },
            ocean: {
                '--bg-primary': '#001a33',
                '--bg-secondary': '#002244',
                '--text-primary': '#e0f0ff',
                '--profit-color': '#00ffcc',
                '--loss-color': '#ff6699'
            },
            sunset: {
                '--bg-primary': '#1a0a00',
                '--bg-secondary': '#331100',
                '--text-primary': '#ffe0cc',
                '--profit-color': '#ffcc00',
                '--loss-color': '#ff4444'
            },
            royal: {
                '--bg-primary': '#0d001a',
                '--bg-secondary': '#1a0033',
                '--text-primary': '#e6ccff',
                '--profit-color': '#cc99ff',
                '--loss-color': '#ff6699'
            },
            hacker: {
                '--bg-primary': '#000a00',
                '--bg-secondary': '#001a00',
                '--text-primary': '#00ff00',
                '--profit-color': '#00ff00',
                '--loss-color': '#ff0000'
            }
        };

        function applyTheme(themeName) {
            const theme = THEMES[themeName] || THEMES.default;
            const root = document.documentElement;

            Object.entries(theme).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });

            // Update button states
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });

            // Save preference
            localStorage.setItem('ogz-theme', themeName);
            console.log(` Theme applied: ${themeName}`);
        }

        function updateAccentColor(color) {
            document.documentElement.style.setProperty('--ml-color', color);
            document.getElementById('colorValue').textContent = color.toUpperCase();
            localStorage.setItem('ogz-accent', color);
            console.log(` Accent color: ${color}`);
        }

        function updateFont(fontFamily) {
            document.body.style.fontFamily = fontFamily;
            localStorage.setItem('ogz-font', fontFamily);
            console.log(` Font: ${fontFamily}`);
        }

        // Load saved theme preferences on startup
        function loadThemePreferences() {
            const savedTheme = localStorage.getItem('ogz-theme');
            const savedAccent = localStorage.getItem('ogz-accent');
            const savedFont = localStorage.getItem('ogz-font');

            if (savedTheme) applyTheme(savedTheme);
            if (savedAccent) {
                document.getElementById('accentColor').value = savedAccent;
                updateAccentColor(savedAccent);
            }
            if (savedFont) {
                document.getElementById('fontSelect').value = savedFont;
                updateFont(savedFont);
            }
        }

        function calculatePosition() {
            const balance = parseFloat(document.getElementById('accountBalance').value) || 0;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 0;
            const entry = parseFloat(document.getElementById('entryPrice').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;

            if (balance && riskPercent && entry && stopLoss && entry !== stopLoss) {
                const riskAmount = balance * (riskPercent / 100);
                const priceDiff = Math.abs(entry - stopLoss);
                const positionSize = riskAmount / priceDiff;

                document.getElementById('positionSize').textContent = positionSize.toFixed(4);
                document.getElementById('riskAmount').textContent = `$${riskAmount.toFixed(2)}`;

                // Calculate R:R if we have TP
                const tp1 = parseFloat(document.getElementById('tp1').value) || 0;
                if (tp1) {
                    const reward = Math.abs(tp1 - entry);
                    const risk = priceDiff;
                    const rr = (reward / risk).toFixed(2);
                    document.getElementById('riskReward').textContent = `1:${rr}`;
                }
            }
        }

        let stopLossMode = 'fixed';

        function setSLMode(mode) {
            stopLossMode = mode;

            // Update button states
            document.querySelectorAll('.sl-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide relevant inputs
            if (mode === 'trailing') {
                document.getElementById('trailDistance').parentElement.style.display = 'flex';
            } else {
                document.getElementById('trailDistance').parentElement.style.display = 'none';
            }

            if (mode === 'breakeven') {
                document.getElementById('beTarget').parentElement.style.display = 'flex';
            } else {
                document.getElementById('beTarget').parentElement.style.display = 'none';
            }
        }

        function applyStopLoss() {
            const currentSL = document.getElementById('currentSL').value;
            const trailDistance = document.getElementById('trailDistance').value;
            const beTarget = document.getElementById('beTarget').value;

            // Send to bot via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'update_stop_loss',
                    mode: stopLossMode,
                    stopLoss: currentSL,
                    trailDistance: trailDistance,
                    breakEvenTarget: beTarget
                }));

                alert(`Stop Loss Updated!\nMode: ${stopLossMode}\nSL: ${currentSL}`);
            } else {
                alert('Not connected to trading bot');
            }
        }

        function setTakeProfits() {
            const tp1 = document.getElementById('tp1').value;
            const tp2 = document.getElementById('tp2').value;
            const tp3 = document.getElementById('tp3').value;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'set_take_profits',
                    targets: [
                        { level: tp1, size: 0.25 },
                        { level: tp2, size: 0.50 },
                        { level: tp3, size: 0.25 }
                    ]
                }));

                alert('Take Profit targets set!');
            }
        }

        // Quick Actions
        function closeHalf() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'close_position',
                    percentage: 50
                }));
                alert('Closing 50% of position...');
            }
        }

        function closeAll() {
            if (confirm('Are you sure you want to close ALL positions?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'close_position',
                        percentage: 100
                    }));
                    alert('Closing all positions...');
                }
            }
        }

        function reversePosition() {
            if (confirm('Reverse current position?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'reverse_position'
                    }));
                    alert('Reversing position...');
                }
            }
        }

        function hedgePosition() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'hedge_position'
                }));
                alert('Opening hedge position...');
            }
        }

        // Auto-populate current price in calculator
        // CHANGE 2026-01-21: Fixed - use lastPrice variable instead of non-existent currentPrice
        setInterval(() => {
            if (lastPrice && !document.getElementById('entryPrice').value) {
                document.getElementById('entryPrice').value = lastPrice.toFixed(2);
            }
        }, 1000);

        // EDGE ANALYTICS FUNCTIONS - THE REAL MONEY MAKERS

        // CVD - Cumulative Volume Delta
        let cvdValue = 0;
        let cvdHistory = [];

        function calculateCVD(trade) {
            // Determine if buy or sell based on price vs ask/bid
            const isBuy = trade.price >= trade.ask;
            const volumeDelta = isBuy ? trade.volume : -trade.volume;

            cvdValue += volumeDelta;
            cvdHistory.push(cvdValue);

            // Keep last 100 values
            if (cvdHistory.length > 100) cvdHistory.shift();

            // Update display
            document.getElementById('cvdValue').textContent = cvdValue.toFixed(0);

            // Determine trend
            const trend = cvdValue > 0 ? 'BULLISH' : cvdValue < 0 ? 'BEARISH' : 'NEUTRAL';
            const trendEl = document.getElementById('cvdTrend');
            trendEl.textContent = trend;
            trendEl.style.color = cvdValue > 0 ? '#00ff88' : cvdValue < 0 ? '#ff0064' : '#ffaa00';

            // Draw mini chart
            drawCVDChart();
        }

        function drawCVDChart() {
            const canvas = document.getElementById('cvdChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (cvdHistory.length < 2) return;

            const max = Math.max(...cvdHistory);
            const min = Math.min(...cvdHistory);
            const range = max - min || 1;

            ctx.strokeStyle = cvdValue > 0 ? '#00ff88' : '#ff0064';
            ctx.lineWidth = 2;
            ctx.beginPath();

            cvdHistory.forEach((val, i) => {
                const x = (i / cvdHistory.length) * canvas.width;
                const y = canvas.height - ((val - min) / range) * canvas.height;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }

        // Real Data Update Functions for Edge Analytics

        // Update CVD with real order flow data
        function updateCVD(cvd, buyVolume, sellVolume) {
            // Use real CVD value from bot
            cvdValue = cvd || (buyVolume - sellVolume) || cvdValue;
            cvdHistory.push(cvdValue);

            // Keep last 100 points
            if (cvdHistory.length > 100) cvdHistory.shift();

            // Update display
            const cvdEl = document.getElementById('cvdValue');
            cvdEl.textContent = cvdValue > 1000000 ? (cvdValue / 1000000).toFixed(2) + 'M' :
                               cvdValue > 1000 ? (cvdValue / 1000).toFixed(1) + 'K' :
                               cvdValue.toFixed(0);

            // Color based on value
            if (cvdValue > 0) {
                cvdEl.style.color = '#00ff88';
            } else if (cvdValue < 0) {
                cvdEl.style.color = '#ff0064';
            } else {
                cvdEl.style.color = '#ffaa00';
            }

            // Update trend
            const trend = cvdValue > 100000 ? 'STRONG BUY PRESSURE' :
                         cvdValue > 10000 ? 'BUY PRESSURE' :
                         cvdValue > 0 ? 'BULLISH' :
                         cvdValue < -100000 ? 'STRONG SELL PRESSURE' :
                         cvdValue < -10000 ? 'SELL PRESSURE' :
                         cvdValue < 0 ? 'BEARISH' : 'NEUTRAL';
            const trendEl = document.getElementById('cvdTrend');
            trendEl.textContent = trend;
            trendEl.style.color = cvdValue > 0 ? '#00ff88' : cvdValue < 0 ? '#ff0064' : '#ffaa00';

            // Draw chart
            drawCVDChart();
        }

        // Update liquidation levels with real data
        function updateLiquidationLevels(levels) {
            if (levels.long) {
                document.getElementById('longLiqPrice').textContent = '$' + levels.long.price.toFixed(2);
                document.getElementById('longLiqVol').textContent = '$' +
                    (levels.long.volume > 1000000 ? (levels.long.volume / 1000000).toFixed(1) + 'M' :
                     levels.long.volume > 1000 ? (levels.long.volume / 1000).toFixed(0) + 'K' :
                     levels.long.volume.toFixed(0));
            }

            if (levels.short) {
                document.getElementById('shortLiqPrice').textContent = '$' + levels.short.price.toFixed(2);
                document.getElementById('shortLiqVol').textContent = '$' +
                    (levels.short.volume > 1000000 ? (levels.short.volume / 1000000).toFixed(1) + 'M' :
                     levels.short.volume > 1000 ? (levels.short.volume / 1000).toFixed(0) + 'K' :
                     levels.short.volume.toFixed(0));
            }

            // Draw heatmap
            // CHANGE 2026-01-21: Fixed - use lastPrice variable
            if (lastPrice && levels.long && levels.short) {
                drawLiquidationHeatmap(lastPrice, levels.long.price, levels.short.price);
            }
        }

        // Update funding rates with real data
        function updateFundingRates(current, predicted) {
            const currentEl = document.getElementById('currentFunding');
            const predictedEl = document.getElementById('predictedFunding');
            const signalEl = document.getElementById('fundingSignal');

            // Update current funding rate
            currentEl.textContent = (current * 100).toFixed(4) + '%';
            currentEl.style.color = current > 0 ? '#ff0064' : '#00ff88';

            // Update predicted funding rate
            if (predicted !== undefined) {
                predictedEl.textContent = (predicted * 100).toFixed(4) + '%';
                predictedEl.style.color = predicted > 0 ? '#ff0064' : '#00ff88';
            }

            // Determine signal
            let signal = 'NEUTRAL';
            let color = '#ffaa00';

            if (current > 0.01) {
                signal = 'SHORTS PAYING LONGS';
                color = '#ff0064';
            } else if (current < -0.01) {
                signal = 'LONGS PAYING SHORTS';
                color = '#00ff88';
            }

            signalEl.textContent = signal;
            signalEl.style.color = color;
        }

        // Process whale alerts with real trade data
        function processWhaleAlert(data) {
            const size = data.size;
            const price = data.price;
            const side = data.side || (data.direction === 'buy' ? 'BUY' : 'SELL');

            // Format size
            const sizeStr = size > 1000000 ? (size / 1000000).toFixed(1) + 'M' :
                           size > 1000 ? (size / 1000).toFixed(0) + 'K' :
                           size.toFixed(0);

            const message = ` ${sizeStr} ${side} @ $${price.toFixed(2)}`;
            addWhaleAlert(message);

            // Flash animation for large trades
            if (size > 1000000) {
                const panel = document.getElementById('edgePanel');
                panel.style.animation = 'pulse 0.5s';
                setTimeout(() => panel.style.animation = '', 500);
            }
        }

        // Update market internals with real data
        function updateMarketInternals(data) {
            if (data.buySellRatio !== undefined) {
                const ratioEl = document.getElementById('buySellRatio');
                ratioEl.textContent = data.buySellRatio.toFixed(2);
                ratioEl.style.color = data.buySellRatio > 1 ? '#00ff88' :
                                     data.buySellRatio < 1 ? '#ff0064' : '#ffaa00';
            }

            if (data.aggressor !== undefined) {
                const aggressorEl = document.getElementById('aggressorSide');
                aggressorEl.textContent = data.aggressor;
                aggressorEl.style.color = data.aggressor === 'BUYERS' ? '#00ff88' :
                                          data.aggressor === 'SELLERS' ? '#ff0064' : '#ffaa00';
            }

            if (data.bookImbalance !== undefined) {
                document.getElementById('bookImbalance').textContent =
                    (data.bookImbalance * 100).toFixed(1) + '%';
            }

            if (data.spread !== undefined) {
                document.getElementById('spreadValue').textContent =
                    (data.spread * 100).toFixed(3) + '%';
            }
        }

        // Update on-chain metrics with real data
        function updateOnChainMetrics(data) {
            if (data.nvt !== undefined) {
                const nvtEl = document.getElementById('nvtSignal');
                nvtEl.textContent = data.nvt.toFixed(1);
                nvtEl.style.color = data.nvt > 150 ? '#ff0064' :
                                   data.nvt < 45 ? '#00ff88' : '#ffaa00';
            }

            if (data.mvrv !== undefined) {
                const mvrvEl = document.getElementById('mvrvRatio');
                mvrvEl.textContent = data.mvrv.toFixed(2);
                mvrvEl.style.color = data.mvrv > 3.7 ? '#ff0064' :
                                    data.mvrv < 1 ? '#00ff88' : '#ffaa00';
            }

            if (data.sopr !== undefined) {
                const soprEl = document.getElementById('soprValue');
                soprEl.textContent = data.sopr.toFixed(3);
                soprEl.style.color = data.sopr > 1 ? '#00ff88' : '#ff0064';
            }

            if (data.exchangeReserve !== undefined) {
                const reserveEl = document.getElementById('exchangeReserve');
                const change = data.exchangeReserve > 0 ? '+' : '';
                reserveEl.textContent = change + data.exchangeReserve.toFixed(1) + '%';
                reserveEl.style.color = data.exchangeReserve < 0 ? '#00ff88' : '#ff0064';
            }
        }

        // Update smart money flow with real data
        function updateSmartMoneyFlow(data) {
            if (data.flow) {
                const flowEl = document.getElementById('smartFlow');
                flowEl.textContent = data.flow;
                flowEl.style.color = data.flow === 'ACCUMULATING' ? '#00ff88' :
                                    data.flow === 'DISTRIBUTING' ? '#ff0064' : '#ffaa00';
            }

            if (data.activity) {
                const activityEl = document.getElementById('instActivity');
                activityEl.textContent = data.activity;
                activityEl.style.color = data.activity === 'HIGH' ? '#ffaa00' :
                                        data.activity === 'EXTREME' ? '#ff0064' : '#666';
            }

            if (data.dormancy !== undefined) {
                const dormancyEl = document.getElementById('dormancy');
                dormancyEl.textContent = data.dormancy;
                dormancyEl.style.color = data.dormancy === 'HIGH' ? '#ff0064' :
                                        data.dormancy === 'LOW' ? '#00ff88' : '#ffaa00';
            }
        }

        // Update Fear & Greed Index with real data
        function updateFearGreedIndex(value) {
            const fgValue = Math.round(value);

            document.getElementById('fgValue').textContent = fgValue;
            document.getElementById('fgFill').style.width = fgValue + '%';

            let label = 'NEUTRAL';
            let color = '#ffaa00';

            if (fgValue < 20) {
                label = 'EXTREME FEAR';
                color = '#ff0000';
            } else if (fgValue < 40) {
                label = 'FEAR';
                color = '#ff6600';
            } else if (fgValue < 60) {
                label = 'NEUTRAL';
                color = '#ffaa00';
            } else if (fgValue < 80) {
                label = 'GREED';
                color = '#66ff00';
            } else {
                label = 'EXTREME GREED';
                color = '#00ff00';
            }

            const labelEl = document.getElementById('fgLabel');
            labelEl.textContent = label;
            labelEl.style.color = color;
            document.getElementById('fgFill').style.background = color;
        }

        // Update divergences with real data
        function updateDivergences(divergences) {
            const container = document.getElementById('divergences');
            container.innerHTML = '';

            divergences.forEach((divergence, index) => {
                if (index >= 3) return; // Show max 3 divergences

                const div = document.createElement('div');
                div.className = 'divergence-item';
                div.style.color = divergence.type === 'bullish' ? '#00ff88' :
                                 divergence.type === 'bearish' ? '#ff0064' : '#ffaa00';
                div.textContent = `${divergence.indicator} ${divergence.type} on ${divergence.timeframe}`;
                container.appendChild(div);
            });

            if (divergences.length === 0) {
                container.innerHTML = '<div class="divergence-item" style="color: #666">No divergences detected</div>';
            }
        }

        // Liquidation Level Calculator
        function calculateLiquidationLevels(currentPrice, leverage = 10) {
            // Calculate typical liquidation levels based on leverage
            const longLiqPrice = currentPrice * (1 - 1/leverage);
            const shortLiqPrice = currentPrice * (1 + 1/leverage);

            // Simulate volume (in real implementation, get from exchange)
            const longLiqVolume = Math.random() * 10000000;
            const shortLiqVolume = Math.random() * 10000000;

            document.getElementById('longLiqPrice').textContent = `$${longLiqPrice.toFixed(2)}`;
            document.getElementById('shortLiqPrice').textContent = `$${shortLiqPrice.toFixed(2)}`;
            document.getElementById('longLiqVol').textContent = `$${(longLiqVolume/1000000).toFixed(2)}M`;
            document.getElementById('shortLiqVol').textContent = `$${(shortLiqVolume/1000000).toFixed(2)}M`;

            // Draw heatmap
            drawLiquidationHeatmap(currentPrice, longLiqPrice, shortLiqPrice);
        }

        function drawLiquidationHeatmap(current, longLiq, shortLiq) {
            // CHANGE 2026-01-21: Add type safety - ensure current is a number
            if (typeof current !== 'number' || isNaN(current)) return;

            const canvas = document.getElementById('liqHeatmap');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Create gradient for heatmap
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(0, 255, 0, 0.8)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 0, 0.5)');
            gradient.addColorStop(1, 'rgba(255, 0, 0, 0.8)');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Mark current price
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            ctx.fillStyle = '#ffffff';
            ctx.font = '10px monospace';
            ctx.fillText('Current: $' + current.toFixed(0), 5, canvas.height / 2 - 5);
        }

        // Whale Alert Monitor
        function monitorWhales() {
            setInterval(() => {
                // Simulate whale activity (in production, monitor actual large trades)
                // CHANGE 2026-01-21: Fixed - use lastPrice variable
                if (Math.random() > 0.8) {
                    const amount = (Math.random() * 10 + 1).toFixed(2);
                    const action = Math.random() > 0.5 ? 'BUY' : 'SELL';
                    const price = lastPrice ? lastPrice.toFixed(2) : '0';

                    addWhaleAlert(` ${amount}M ${action} @ $${price}`);
                }
            }, 10000);
        }

        function addWhaleAlert(message) {
            const container = document.getElementById('whaleAlerts');
            const alert = document.createElement('div');
            alert.className = 'whale-item';
            alert.textContent = `${new Date().toLocaleTimeString()}: ${message}`;

            container.insertBefore(alert, container.firstChild);

            // Keep only last 5 alerts
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }

        // Fear & Greed Calculator
        function updateFearGreed() {
            // Calculate based on multiple factors
            const factors = {
                volatility: Math.random() * 30,
                momentum: Math.random() * 20,
                volume: Math.random() * 15,
                social: Math.random() * 15,
                dominance: Math.random() * 10,
                trends: Math.random() * 10
            };

            const fgValue = Object.values(factors).reduce((a, b) => a + b, 0);

            document.getElementById('fgValue').textContent = Math.round(fgValue);
            document.getElementById('fgFill').style.width = fgValue + '%';

            let label = 'NEUTRAL';
            let color = '#ffaa00';

            if (fgValue < 25) {
                label = 'EXTREME FEAR';
                color = '#ff0000';
            } else if (fgValue < 45) {
                label = 'FEAR';
                color = '#ff6600';
            } else if (fgValue < 55) {
                label = 'NEUTRAL';
                color = '#ffaa00';
            } else if (fgValue < 75) {
                label = 'GREED';
                color = '#66ff00';
            } else {
                label = 'EXTREME GREED';
                color = '#00ff00';
            }

            const labelEl = document.getElementById('fgLabel');
            labelEl.textContent = label;
            labelEl.style.color = color;
        }

        // Smart Money Flow Analysis
        function analyzeSmartMoney() {
            // Simulate smart money analysis
            const flows = ['ACCUMULATING', 'DISTRIBUTING', 'NEUTRAL'];
            const activity = ['HIGH', 'MEDIUM', 'LOW'];
            const dormancy = ['HIGH', 'MEDIUM', 'LOW'];

            setInterval(() => {
                document.getElementById('smartFlow').textContent = flows[Math.floor(Math.random() * 3)];
                document.getElementById('instActivity').textContent = activity[Math.floor(Math.random() * 3)];
                document.getElementById('dormancy').textContent = dormancy[Math.floor(Math.random() * 3)];
            }, 30000);
        }

        // Hidden Divergence Scanner
        function scanDivergences() {
            setInterval(() => {
                const container = document.getElementById('divergences');
                container.innerHTML = '';

                // Check for divergences
                const divergences = [
                    'RSI Bullish Divergence on 4H',
                    'MACD Hidden Bearish on 1H',
                    'Volume Divergence on Daily',
                    'OBV Divergence Forming'
                ];

                const selectedDiv = divergences[Math.floor(Math.random() * divergences.length)];

                const div = document.createElement('div');
                div.className = 'divergence-item';
                div.textContent = selectedDiv;
                container.appendChild(div);
            }, 15000);
        }

        // Initialize Edge Analytics
        function initializeEdgeAnalytics() {
            monitorWhales();
            updateFearGreed();
            analyzeSmartMoney();
            scanDivergences();

            // Update liquidation levels every minute
            // CHANGE 2026-01-21: Fixed - use lastPrice variable
            setInterval(() => {
                if (lastPrice) {
                    calculateLiquidationLevels(lastPrice);
                }
            }, 60000);

            // Update market internals
            setInterval(() => {
                document.getElementById('buySellRatio').textContent = (0.8 + Math.random() * 0.4).toFixed(2);
                document.getElementById('bookImbalance').textContent = (Math.random() * 20 - 10).toFixed(1) + '%';
                document.getElementById('spreadValue').textContent = (Math.random() * 0.1).toFixed(3) + '%';

                const aggressor = Math.random() > 0.5 ? 'BUYERS' : 'SELLERS';
                document.getElementById('aggressorSide').textContent = aggressor;
            }, 5000);
        }

        // Start edge analytics
        initializeEdgeAnalytics();
    </script>

    <!-- TRAI Chat Widget -->
    <script src="trai-widget.js"></script>
</body>
</html>